<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AskTelegram â€¢ Anonim Soru & Mesaj</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ã–nceki CSS kodlarÄ±nÄ± buraya kopyala (tam aynÄ±) */
        /* YukarÄ±daki CSS'i deÄŸiÅŸtirmeden olduÄŸu gibi kullan */
        
        /* Ek: BaÄŸlantÄ± kontrolÃ¼ iÃ§in ek CSS */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            z-index: 9999;
            font-weight: 600;
            animation: slideDown 0.3s;
        }
        
        .connection-status.error {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
        }
        
        .connection-status.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .retry-button {
            background: white;
            color: #d97706;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .retry-button:hover {
            background: #f0f0f0;
        }
        
        .db-checking {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
        }
        
        .db-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- BaÄŸlantÄ± Durumu GÃ¶stergesi -->
    <div id="connection-status" class="connection-status" style="display: none;"></div>
    
    <!-- Database Kontrol EkranÄ± -->
    <div id="db-checking-screen" class="db-checking" style="display: none;">
        <div class="db-spinner"></div>
        <h2>VeritabanÄ± BaÄŸlantÄ±sÄ± Kontrol Ediliyor</h2>
        <p id="db-status-text">MongoDB'ye baÄŸlanÄ±yor...</p>
        <div style="margin-top: 30px;">
            <button id="retry-db-btn" class="btn btn-primary" style="margin-bottom: 10px;">
                <i class="fas fa-redo"></i> Tekrar Dene
            </button>
            <br>
            <button id="use-test-mode" class="btn btn-secondary">
                <i class="fas fa-flask"></i> Test Modunda Devam Et
            </button>
        </div>
        <div style="margin-top: 40px; font-size: 14px; color: #666; max-width: 300px;">
            <p><i class="fas fa-info-circle"></i> Telegram giriÅŸi iÃ§in veritabanÄ± baÄŸlantÄ±sÄ± gereklidir.</p>
            <p><i class="fas fa-bolt"></i> Test modunda demo verilerle deneyebilirsiniz.</p>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-logo">ğŸ’¬</div>
        <div class="loading-spinner"></div>
        <h1 style="font-size: 28px; margin-bottom: 10px; font-weight: 800;">AskTelegram</h1>
        <p style="opacity: 0.9; margin-bottom: 20px;">Telegram profilinizle anonim soru ve mesaj</p>
        <div id="loading-details" style="font-size: 14px; opacity: 0.7;">
            BaÅŸlatÄ±lÄ±yor...
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-title" id="header-title">AskTelegram</div>
            <div class="header-actions">
                <button class="header-btn" id="search-btn" title="Ara">
                    <i class="fas fa-search"></i>
                </button>
                <button class="header-btn" id="notifications-btn" title="Bildirimler">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-badge" style="display: none;"></span>
                </button>
                <button class="header-btn" id="settings-btn" title="Ayarlar">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Profile Screen -->
            <div id="profile-screen" class="screen active">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="profile-avatar-img" src="" alt="Profil" onerror="this.src='https://ui-avatars.com/api/?name=U&background=667eea&color=fff&size=150'">
                        <div class="online-status" id="online-status"></div>
                    </div>
                    <h1 class="profile-name" id="profile-name">AskTelegram</h1>
                    <div class="profile-username" id="profile-username">@kullanici</div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="questions-received">0</span>
                            <span class="stat-label">Soru</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="questions-answered">0</span>
                            <span class="stat-label">YanÄ±t</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="messages-sent">0</span>
                            <span class="stat-label">Mesaj</span>
                        </div>
                    </div>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-question-circle"></i></div>
                        <div class="stat-value" id="unanswered-questions">0</div>
                        <div class="stat-label">YanÄ±t Bekleyen</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-comments"></i></div>
                        <div class="stat-value" id="active-conversations">0</div>
                        <div class="stat-label">KonuÅŸma</div>
                    </div>
                </div>

                <!-- Tab Navigation for Questions -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="unanswered">YanÄ±t Bekleyen</button>
                    <button class="tab-btn" data-tab="answered">YanÄ±tlanan</button>
                    <button class="tab-btn" data-tab="all">TÃ¼m Sorular</button>
                </div>

                <!-- Questions List -->
                <div class="questions-list" id="questions-list">
                    <!-- Questions will be loaded here -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="empty-questions" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-question-circle"></i></div>
                    <h3>HenÃ¼z sorunuz yok</h3>
                    <p>Profilinizi paylaÅŸarak soru almaya baÅŸlayÄ±n!</p>
                </div>
            </div>

            <!-- Explore Screen -->
            <div id="explore-screen" class="screen">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="user-search" placeholder="KullanÄ±cÄ± ara...">
                </div>
                <div class="users-grid" id="users-grid">
                    <!-- Users will be loaded here -->
                </div>
                <div class="empty-state" id="empty-users" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-users"></i></div>
                    <h3>KullanÄ±cÄ± bulunamadÄ±</h3>
                    <p>Arama kriterlerinize uygun kullanÄ±cÄ± yok</p>
                </div>
            </div>

            <!-- Messages Screen -->
            <div id="messages-screen" class="screen">
                <h2 class="section-title">Mesajlar</h2>
                <div class="conversations-list" id="conversations-list">
                    <!-- Conversations will be loaded here -->
                </div>
                <div class="empty-state" id="empty-messages" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-comments"></i></div>
                    <h3>HenÃ¼z mesajÄ±nÄ±z yok</h3>
                    <p>Bir kullanÄ±cÄ±ya mesaj gÃ¶ndererek baÅŸlayÄ±n!</p>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chat-screen" class="screen">
                <div class="chat-header">
                    <button class="chat-back-btn" id="chat-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-user-info">
                        <div class="chat-user-name" id="chat-user-name">...</div>
                        <div class="chat-user-status" id="chat-user-status">Ã§evrimdÄ±ÅŸÄ±</div>
                    </div>
                </div>
                <div class="messages-container" id="messages-container">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Mesaj yaz...">
                        <button class="send-btn" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-screen="profile">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item" data-screen="explore">
                <div class="nav-icon"><i class="fas fa-compass"></i></div>
                <span>KeÅŸfet</span>
            </a>
            <a href="#" class="nav-item" data-screen="messages">
                <div class="nav-icon"><i class="fas fa-comments"></i></div>
                <span>Mesajlar</span>
                <span class="notification-badge" id="messages-badge" style="display: none;">0</span>
            </a>
        </nav>
    </div>

    <!-- Modals (AynÄ± kalacak) -->
    <!-- Ask Question Modal -->
    <div id="ask-question-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Soru Sor</h3>
                <button class="modal-close" id="close-question-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Soru</label>
                    <textarea class="form-control" id="question-text" placeholder="Sorunuzu yazÄ±n..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <div class="toggle-switch" id="anonymous-toggle">
                        <div class="toggle-track active">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span>Anonim olarak sor</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">GÃ¶nderilecek kiÅŸi</label>
                    <div id="target-user-info" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-100); border-radius: var(--radius-sm);">
                        <img id="target-user-avatar" src="" style="width: 40px; height: 40px; border-radius: 50%;" onerror="this.src='https://ui-avatars.com/api/?name=U&background=667eea&color=fff&size=150'">
                        <div>
                            <div id="target-user-name" style="font-weight: 600;"></div>
                            <div id="target-user-username" style="font-size: 14px; color: var(--gray-500);"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-question">Ä°ptal</button>
                <button class="btn btn-primary" id="send-question-btn">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div id="send-message-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Mesaj GÃ¶nder</h3>
                <button class="modal-close" id="close-message-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Mesaj</label>
                    <textarea class="form-control" id="message-text" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <div class="toggle-switch" id="message-anonymous-toggle">
                        <div class="toggle-track active">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span>Anonim olarak gÃ¶nder</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">GÃ¶nderilecek kiÅŸi</label>
                    <div id="message-target-info" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-100); border-radius: var(--radius-sm);">
                        <img id="message-target-avatar" src="" style="width: 40px; height: 40px; border-radius: 50%;" onerror="this.src='https://ui-avatars.com/api/?name=U&background=667eea&color=fff&size=150'">
                        <div>
                            <div id="message-target-name" style="font-weight: 600;"></div>
                            <div id="message-target-username" style="font-size: 14px; color: var(--gray-500);"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-message">Ä°ptal</button>
                <button class="btn btn-primary" id="send-message-btn">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <!-- Answer Question Modal -->
    <div id="answer-question-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Soruyu YanÄ±tla</h3>
                <button class="modal-close" id="close-answer-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="question-card" style="margin: 0; border: none; padding: 0;">
                    <div class="question-header">
                        <div class="question-avatar">
                            <img id="question-asker-avatar" src="" alt="Soran" onerror="this.src='https://ui-avatars.com/api/?name=A&background=94a3b8&color=fff&size=150'">
                        </div>
                        <div class="question-info">
                            <div class="question-author" id="question-asker-name">Anonim1234</div>
                            <div class="question-time" id="question-time">Åimdi</div>
                        </div>
                    </div>
                    <div class="question-text" id="question-content">...</div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">YanÄ±tÄ±nÄ±z</label>
                    <textarea class="form-control" id="answer-text" placeholder="YanÄ±tÄ±nÄ±zÄ± yazÄ±n..." rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-answer">Ä°ptal</button>
                <button class="btn btn-primary" id="submit-answer-btn">YanÄ±tla</button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Bildirimler</h3>
                <button class="modal-close" id="close-notifications-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="notifications-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Notifications will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-notifications">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ayarlar</h3>
                <button class="modal-close" id="close-settings-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Profil AyarlarÄ±</label>
                    <div class="toggle-switch" style="margin-bottom: 15px;">
                        <div class="toggle-track active" id="toggle-anonymous-questions">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span>Anonim soru kabul et</span>
                    </div>
                    <div class="toggle-switch" style="margin-bottom: 15px;">
                        <div class="toggle-track active" id="toggle-anonymous-messages">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span>Anonim mesaj kabul et</span>
                    </div>
                    <div class="toggle-switch">
                        <div class="toggle-track active" id="toggle-online-status">
                            <div class="toggle-thumb"></div>
                        </div>
                        <span>Ã‡evrimiÃ§i durumunu gÃ¶ster</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">BaÄŸlantÄ± Durumu</label>
                    <div id="connection-info" style="padding: 10px; background: var(--gray-100); border-radius: var(--radius-sm); font-size: 14px;">
                        <div>MongoDB: <span id="db-status">Kontrol ediliyor...</span></div>
                        <div>Socket: <span id="socket-status">BaÄŸlanÄ±yor...</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">HakkÄ±nda</label>
                    <p style="font-size: 14px; color: var(--gray-600); line-height: 1.5;">
                        AskTelegram v1.0<br>
                        Telegram WebApp entegrasyonu<br>
                        MongoDB veritabanÄ±
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-settings">Kapat</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let socket = null;
        let currentChatUser = null;
        let currentConversationId = null;
        let notificationsCount = 0;
        let unreadMessagesCount = 0;
        let isTestMode = false;
        let dbCheckInterval = null;
        let connectionRetries = 0;
        const MAX_RETRIES = 5;

        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor...');
            
            // Check if Telegram WebApp is available
            if (typeof Telegram !== 'undefined' && tg) {
                console.log('ğŸ“± Telegram WebApp tespit edildi');
                tg.expand();
                tg.enableClosingConfirmation();
                
                // Set theme
                if (tg.colorScheme === 'dark') {
                    document.body.classList.add('dark-mode');
                }
            } else {
                console.log('â„¹ï¸ Telegram WebApp bulunamadÄ±, tarayÄ±cÄ± modunda Ã§alÄ±ÅŸÄ±lÄ±yor');
            }
            
            // First check server health
            await checkServerHealth();
        });

        // Check server health and database connection
        async function checkServerHealth() {
            try {
                updateLoadingText('Sunucu baÄŸlantÄ±sÄ± kontrol ediliyor...');
                
                // Check server health
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                console.log('ğŸ¥ Sunucu saÄŸlÄ±k durumu:', healthData);
                
                if (healthData.dbConnected) {
                    // Database connected, proceed with app
                    console.log('âœ… VeritabanÄ± baÄŸlÄ±, uygulama baÅŸlatÄ±lÄ±yor');
                    hideDbCheckingScreen();
                    await initializeApp();
                } else {
                    // Database not connected, show checking screen
                    console.log('âš ï¸ VeritabanÄ± baÄŸlÄ± deÄŸil, bekleniyor...');
                    showDbCheckingScreen('MongoDB baÄŸlantÄ±sÄ± bekleniyor...');
                    
                    // Start periodic checking
                    startDbChecking();
                }
                
            } catch (error) {
                console.error('âŒ Sunucu baÄŸlantÄ± hatasÄ±:', error);
                showDbCheckingScreen('Sunucuya baÄŸlanÄ±lamÄ±yor. Tekrar deneyin...');
                
                // Show retry button
                document.getElementById('db-status-text').innerHTML = `
                    Sunucu baÄŸlantÄ± hatasÄ±: ${error.message}<br>
                    <small>Sunucunun Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.</small>
                `;
                
                connectionRetries++;
                
                if (connectionRetries >= MAX_RETRIES) {
                    document.getElementById('db-status-text').innerHTML += '<br><strong>Maksimum deneme sayÄ±sÄ±na ulaÅŸÄ±ldÄ±. Test modunu kullanÄ±n.</strong>';
                }
            }
        }

        // Show database checking screen
        function showDbCheckingScreen(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('db-checking-screen').style.display = 'flex';
            document.getElementById('db-status-text').textContent = message;
        }

        // Hide database checking screen
        function hideDbCheckingScreen() {
            document.getElementById('db-checking-screen').style.display = 'none';
        }

        // Start periodic database checking
        function startDbChecking() {
            if (dbCheckInterval) clearInterval(dbCheckInterval);
            
            dbCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    
                    if (data.dbConnected) {
                        console.log('âœ… VeritabanÄ± baÄŸlantÄ±sÄ± saÄŸlandÄ±!');
                        clearInterval(dbCheckInterval);
                        hideDbCheckingScreen();
                        await initializeApp();
                    } else {
                        document.getElementById('db-status-text').textContent = 
                            `MongoDB baÄŸlantÄ±sÄ± bekleniyor... (${new Date().toLocaleTimeString()})`;
                    }
                } catch (error) {
                    console.log('ğŸ”„ BaÄŸlantÄ± kontrol hatasÄ±:', error.message);
                }
            }, 3000);
        }

        // Initialize the application
        async function initializeApp() {
            try {
                updateLoadingText('Uygulama hazÄ±rlanÄ±yor...');
                
                // Initialize Socket.io
                initializeSocket();
                
                // Set up event listeners
                setupEventListeners();
                
                // Try to authenticate with Telegram
                await authenticateWithTelegram();
                
                // Load initial data
                await loadInitialData();
                
                // Hide loading and show app
                hideLoadingScreen();
                
            } catch (error) {
                console.error('âŒ Uygulama baÅŸlatma hatasÄ±:', error);
                showConnectionError('Uygulama baÅŸlatÄ±lamadÄ±: ' + error.message);
            }
        }

        // Authenticate with Telegram
        async function authenticateWithTelegram() {
            try {
                updateLoadingText('Telegram ile giriÅŸ yapÄ±lÄ±yor...');
                
                // Check if Telegram WebApp has user data
                let userData = null;
                let initData = 'test'; // Default to test mode
                
                if (tg && tg.initData) {
                    console.log('ğŸ” Telegram WebApp verisi bulundu');
                    initData = tg.initData;
                    userData = tg.initDataUnsafe.user;
                } else {
                    console.log('ğŸ§ª Test modu aktif (Telegram verisi yok)');
                    isTestMode = true;
                    
                    // Create test user data
                    userData = {
                        id: Date.now(),
                        first_name: 'Test',
                        last_name: 'KullanÄ±cÄ±',
                        username: 'testuser_' + Date.now(),
                        photo_url: ''
                    };
                }
                
                console.log('ğŸ‘¤ KullanÄ±cÄ± verisi:', userData);
                
                // Send authentication request
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: initData,
                        user: userData
                    })
                });
                
                const data = await response.json();
                console.log('ğŸ”‘ Auth yanÄ±tÄ±:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    console.log('âœ… GiriÅŸ baÅŸarÄ±lÄ±:', currentUser.displayName);
                    
                    // Update profile UI
                    updateProfileUI();
                    
                    // Show success notification
                    if (isTestMode) {
                        showConnectionStatus('Test modu aktif - Demo verilerle Ã§alÄ±ÅŸÄ±yorsunuz', 'success');
                    } else {
                        showConnectionStatus('Telegram giriÅŸi baÅŸarÄ±lÄ±!', 'success');
                    }
                    
                } else {
                    throw new Error(data.error || 'Kimlik doÄŸrulama baÅŸarÄ±sÄ±z');
                }
                
            } catch (error) {
                console.error('âŒ Telegram kimlik doÄŸrulama hatasÄ±:', error);
                
                // Fallback: create test user
                await createTestUser();
            }
        }

        // Create test user as fallback
        async function createTestUser() {
            try {
                console.log('ğŸ”„ Test kullanÄ±cÄ±sÄ± oluÅŸturuluyor...');
                
                const response = await fetch('/api/test/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'Demo KullanÄ±cÄ±'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isTestMode = true;
                    
                    console.log('âœ… Test kullanÄ±cÄ±sÄ± oluÅŸturuldu:', currentUser.displayName);
                    updateProfileUI();
                    
                    showConnectionStatus('Demo modu: Test kullanÄ±cÄ±sÄ± ile giriÅŸ yapÄ±ldÄ±', 'success');
                } else {
                    throw new Error('Test kullanÄ±cÄ±sÄ± oluÅŸturulamadÄ±');
                }
                
            } catch (error) {
                console.error('âŒ Test kullanÄ±cÄ±sÄ± oluÅŸturma hatasÄ±:', error);
                
                // Ultimate fallback: local test user
                currentUser = {
                    _id: 'local_test_user',
                    telegramId: 'local_' + Date.now(),
                    displayName: 'Yerel KullanÄ±cÄ±',
                    username: 'localuser',
                    photoUrl: 'https://ui-avatars.com/api/?name=Y+K&background=667eea&color=fff&size=150',
                    bio: 'Yerel test kullanÄ±cÄ±sÄ±',
                    stats: {
                        questionsReceived: 5,
                        questionsAnswered: 3,
                        messagesSent: 12
                    },
                    settings: {
                        allowAnonymousQuestions: true,
                        allowAnonymousMessages: true,
                        showOnlineStatus: true
                    },
                    isOnline: true,
                    lastSeen: new Date()
                };
                
                isTestMode = true;
                updateProfileUI();
                
                showConnectionStatus('Yerel demo modu aktif', 'warning');
            }
        }

        // Update loading text
        function updateLoadingText(text) {
            const loadingDetails = document.getElementById('loading-details');
            if (loadingDetails) {
                loadingDetails.textContent = text;
            }
        }

        // Show connection status
        function showConnectionStatus(message, type = 'info') {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = message;
            statusElement.className = `connection-status ${type}`;
            statusElement.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Show connection error
        function showConnectionError(message) {
            showConnectionStatus('âŒ ' + message, 'error');
            
            // Show retry button
            const statusElement = document.getElementById('connection-status');
            const retryButton = document.createElement('button');
            retryButton.className = 'retry-button';
            retryButton.textContent = 'Tekrar Dene';
            retryButton.onclick = () => {
                window.location.reload();
            };
            
            statusElement.appendChild(retryButton);
        }

        // Update profile UI
        function updateProfileUI() {
            if (!currentUser) return;
            
            console.log('ğŸ¨ Profil UI gÃ¼ncelleniyor:', currentUser.displayName);
            
            // Update profile elements
            document.getElementById('profile-name').textContent = currentUser.displayName;
            document.getElementById('profile-username').textContent = '@' + currentUser.username;
            document.getElementById('profile-avatar-img').src = currentUser.photoUrl;
            document.getElementById('questions-received').textContent = currentUser.stats.questionsReceived || 0;
            document.getElementById('questions-answered').textContent = currentUser.stats.questionsAnswered || 0;
            document.getElementById('messages-sent').textContent = currentUser.stats.messagesSent || 0;
            
            // Update online status
            const onlineStatus = document.getElementById('online-status');
            if (currentUser.isOnline) {
                onlineStatus.style.background = 'var(--success)';
                onlineStatus.title = 'Ã‡evrimiÃ§i';
            } else {
                onlineStatus.style.background = 'var(--gray-400)';
                onlineStatus.title = 'Ã‡evrimdÄ±ÅŸÄ±';
            }
            
            // Update settings toggles
            document.getElementById('toggle-anonymous-questions').classList.toggle('active', currentUser.settings.allowAnonymousQuestions);
            document.getElementById('toggle-anonymous-messages').classList.toggle('active', currentUser.settings.allowAnonymousMessages);
            document.getElementById('toggle-online-status').classList.toggle('active', currentUser.settings.showOnlineStatus);
        }

        // Hide loading screen and show app
        function hideLoadingScreen() {
            console.log('ğŸ‘‹ Loading ekranÄ± kapatÄ±lÄ±yor...');
            
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.querySelector('.app-container').style.display = 'block';
                console.log('ğŸš€ Uygulama baÅŸlatÄ±ldÄ±!');
            }, 300);
        }

        // Initialize Socket.io connection
        function initializeSocket() {
            console.log('ğŸ”Œ Socket.io baÄŸlantÄ±sÄ± kuruluyor...');
            
            try {
                socket = io({
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                socket.on('connect', () => {
                    console.log('âœ… Socket baÄŸlandÄ±:', socket.id);
                    showConnectionStatus('GerÃ§ek zamanlÄ± baÄŸlantÄ± kuruldu', 'success');
                    
                    // Notify server that user is online
                    if (currentUser && socket) {
                        socket.emit('user_online', currentUser._id);
                    }
                });
                
                socket.on('new_question', (question) => {
                    console.log('â“ Yeni soru:', question);
                    showNotification('Yeni bir sorunuz var!', 'info');
                    loadQuestions();
                    updateNotificationBadge();
                });
                
                socket.on('new_message', (message) => {
                    console.log('ğŸ’¬ Yeni mesaj:', message);
                    showNotification('Yeni mesajÄ±nÄ±z var!', 'info');
                    loadConversations();
                    updateNotificationBadge();
                });
                
                socket.on('new_private_message', (message) => {
                    console.log('ğŸ“¨ Yeni Ã¶zel mesaj:', message);
                    
                    // If we're in the chat with this user, show the message
                    if (currentConversationId === message.conversationId) {
                        displayMessage(message);
                    } else {
                        showNotification('Yeni mesajÄ±nÄ±z var!', 'info');
                        unreadMessagesCount++;
                        updateNotificationBadge();
                    }
                    loadConversations();
                });
                
                socket.on('message_sent', (data) => {
                    console.log('âœ… Mesaj gÃ¶nderildi:', data.messageId);
                    if (data.message) {
                        displayMessage(data.message);
                    }
                });
                
                socket.on('message_error', (data) => {
                    console.error('âŒ Mesaj gÃ¶nderme hatasÄ±:', data.error);
                    showNotification('Mesaj gÃ¶nderilemedi: ' + data.error, 'error');
                });
                
                socket.on('user_status_changed', (data) => {
                    console.log('ğŸ”„ KullanÄ±cÄ± durumu deÄŸiÅŸti:', data);
                    
                    // Update user status in UI if they're in our current chat
                    if (currentChatUser && currentChatUser._id === data.userId) {
                        const statusElement = document.getElementById('chat-user-status');
                        statusElement.textContent = data.isOnline ? 'Ã§evrimiÃ§i' : 'Ã§evrimdÄ±ÅŸÄ±';
                        statusElement.classList.toggle('online', data.isOnline);
                    }
                });
                
                socket.on('disconnect', () => {
                    console.log('ğŸ”Œ Socket baÄŸlantÄ±sÄ± kesildi');
                    showConnectionStatus('BaÄŸlantÄ± kesildi, yeniden baÄŸlanÄ±lÄ±yor...', 'warning');
                });
                
                socket.on('reconnect', (attemptNumber) => {
                    console.log('ğŸ”„ Socket yeniden baÄŸlandÄ±, deneme:', attemptNumber);
                    showConnectionStatus('BaÄŸlantÄ± yeniden kuruldu', 'success');
                });
                
                socket.on('connect_error', (error) => {
                    console.error('âŒ Socket baÄŸlantÄ± hatasÄ±:', error);
                    showConnectionStatus('GerÃ§ek zamanlÄ± baÄŸlantÄ± hatasÄ±', 'error');
                });
                
            } catch (error) {
                console.error('âŒ Socket.io baÅŸlatma hatasÄ±:', error);
                showConnectionStatus('GerÃ§ek zamanlÄ± Ã¶zellikler devre dÄ±ÅŸÄ±', 'warning');
            }
        }

        // Set up all event listeners
        function setupEventListeners() {
            console.log('ğŸ¯ Event listenerlar kuruluyor...');
            
            // Retry DB button
            document.getElementById('retry-db-btn').addEventListener('click', () => {
                window.location.reload();
            });
            
            // Test mode button
            document.getElementById('use-test-mode').addEventListener('click', async () => {
                isTestMode = true;
                hideDbCheckingScreen();
                document.getElementById('loading-screen').style.display = 'flex';
                await createTestUser();
                await initializeApp();
            });
            
            // Bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const screen = item.getAttribute('data-screen');
                    switchScreen(screen);
                    
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    item.classList.add('active');
                });
            });
            
            // Tab navigation for questions
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab-btn').forEach(t => {
                        t.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    // Load questions for selected tab
                    loadQuestions(tab);
                });
            });
            
            // Header buttons
            document.getElementById('search-btn').addEventListener('click', () => {
                switchScreen('explore');
                setTimeout(() => {
                    document.getElementById('user-search').focus();
                }, 100);
            });
            
            document.getElementById('notifications-btn').addEventListener('click', showNotificationsModal);
            document.getElementById('settings-btn').addEventListener('click', showSettingsModal);
            
            // User search
            document.getElementById('user-search').addEventListener('input', debounce(searchUsers, 300));
            
            // Chat back button
            document.getElementById('chat-back-btn').addEventListener('click', () => {
                switchScreen('messages');
            });
            
            // Send message button
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Modal close buttons
            document.getElementById('close-question-modal').addEventListener('click', () => {
                document.getElementById('ask-question-modal').style.display = 'none';
            });
            
            document.getElementById('close-message-modal').addEventListener('click', () => {
                document.getElementById('send-message-modal').style.display = 'none';
            });
            
            document.getElementById('close-answer-modal').addEventListener('click', () => {
                document.getElementById('answer-question-modal').style.display = 'none';
            });
            
            document.getElementById('close-notifications-modal').addEventListener('click', () => {
                document.getElementById('notifications-modal').style.display = 'none';
            });
            
            document.getElementById('close-settings-modal').addEventListener('click', () => {
                document.getElementById('settings-modal').style.display = 'none';
            });
            
            // Modal cancel buttons
            document.getElementById('cancel-question').addEventListener('click', () => {
                document.getElementById('ask-question-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-message').addEventListener('click', () => {
                document.getElementById('send-message-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-answer').addEventListener('click', () => {
                document.getElementById('answer-question-modal').style.display = 'none';
            });
            
            document.getElementById('close-notifications').addEventListener('click', () => {
                document.getElementById('notifications-modal').style.display = 'none';
            });
            
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-modal').style.display = 'none';
            });
            
            // Modal action buttons
            document.getElementById('send-question-btn').addEventListener('click', submitQuestion);
            document.getElementById('send-message-btn').addEventListener('click', submitMessage);
            document.getElementById('submit-answer-btn').addEventListener('click', submitAnswer);
            
            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const track = this.querySelector('.toggle-track');
                    track.classList.toggle('active');
                });
            });
            
            console.log('âœ… Event listenerlar kuruldu');
        }

        // Load initial data
        async function loadInitialData() {
            if (!currentUser) return;
            
            try {
                console.log('ğŸ“¦ Ä°lk veriler yÃ¼kleniyor...');
                
                // Load user's questions
                await loadQuestions('unanswered');
                
                // Load users for explore screen
                await loadExploreUsers();
                
                // Load conversations
                await loadConversations();
                
                // Load notifications
                await loadNotifications();
                
                console.log('âœ… Ä°lk veriler yÃ¼klendi');
                
            } catch (error) {
                console.error('âŒ Veri yÃ¼kleme hatasÄ±:', error);
                showConnectionError('Veriler yÃ¼klenemedi: ' + error.message);
            }
        }

        // [Kalan fonksiyonlar aynÄ± kalacak - loadQuestions, createQuestionElement, loadExploreUsers, createUserElement, vs.]
        // YukarÄ±daki tÃ¼m fonksiyonlarÄ± olduÄŸu gibi kopyala...

    </script>
</body>
</html>
