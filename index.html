<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>M…ôl…ôk</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{
  margin:0;
  background:#0e1621;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#17212b;
  padding:14px 16px;
  font-size:18px;
  font-weight:600;
}
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:78%;
  padding:10px 14px;
  border-radius:16px;
  margin-bottom:10px;
  line-height:1.4;
}
.in{background:#1f2c3a;align-self:flex-start}
.out{background:#4da3ff;color:#000;align-self:flex-end}

#typing{
  display:none;
  text-align:center;
  font-size:20px;
  color:#00eaff;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}

footer{
  background:#17212b;
  padding:10px;
  display:flex;
  gap:8px;
}
input{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  font-size:15px;
}
button{
  background:#4da3ff;
  border:none;
  padding:0 18px;
  border-radius:10px;
  font-size:16px;
}
</style>
</head>

<body>

<header id="title">M…ôl…ôk</header>

<div id="chat"></div>
<div id="typing">M…ôl…ôk yazƒ±r‚Ä¶</div>

<footer>
  <input id="input" placeholder="Mesaj yaz‚Ä¶" autocomplete="off">
  <button onclick="send()">‚û§</button>
</footer>

<script>
/* ================= TELEGRAM FULLSCREEN ================= */
if(window.Telegram && Telegram.WebApp){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();          // full screen
  Telegram.WebApp.enableClosingConfirmation();
  Telegram.WebApp.setHeaderColor("#17212b");
  Telegram.WebApp.setBackgroundColor("#0e1621");
}

/* ================= USER DETECTION ================= */
let tgUser = Telegram?.WebApp?.initDataUnsafe?.user || {};
let userName = tgUser.first_name || localStorage.getItem("userName") || "Dost";

localStorage.setItem("userName", userName);

/* ================= UI ================= */
const chat = document.getElementById("chat");
const typing = document.getElementById("typing");
const input = document.getElementById("input");
const title = document.getElementById("title");

title.innerText = "M…ôl…ôk ‚Ä¢ " + userName;

function add(text,type){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerText=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
function showTyping(v){typing.style.display=v?"block":"none"}

/* ================= GREETING (ONCE) ================= */
if(!localStorage.getItem("greeted")){
  add(`Salam ${userName} üëã M…ôn M…ôl…ôy…ôm. Dost kimi danƒ±≈üacaƒüƒ±q.`,"in");
  localStorage.setItem("greeted","1");
}

/* ================= QUEUE SYSTEM ================= */
let queue=[], busy=false;

function send(){
  const t=input.value.trim();
  if(!t) return;
  input.value="";
  add(t,"out");
  queue.push(t);
  process();
}

async function process(){
  if(busy||!queue.length) return;
  busy=true;
  showTyping(true);

  const msg=queue.shift();
  const reply=await askAI(msg);

  showTyping(false);
  add(reply,"in");
  busy=false;
  setTimeout(process,300);
}

/* ================= AI ================= */
async function askAI(text){
  const systemPrompt = `
S…ôn M…ôl…ôk adlƒ± dostca AI-san.
ƒ∞stifad…ô√ßinin adƒ±: ${userName}
√áox uzun yazma.
S…ômimi danƒ±≈ü.
Sahibin Xaliq Mustafayevdir.
Soru≈üulsa de:
"M…ôni kodlayan v…ô sahibim Xaliq Mustafayevdir.
Telegram v…ô Instagram: @xaliqmustafayev"
Sual:
${text}
`;

  try{
    const r=await fetch(
      "https://text.pollinations.ai/"+encodeURIComponent(systemPrompt),
      {cache:"no-store"}
    );
    if(!r.ok) throw 1;
    return await r.text();
  }catch{
    return "Buradayam, davam ed…ô bil…ôrik üôÇ";
  }
}

/* Enter */
input.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});
</script>

</body>
</html>
