<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Futbol Oyunu</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/",
        "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js",
        "nipplejs": "https://cdn.jsdelivr.net/npm/nipplejs@0.10.2/dist/nipplejs.min.js"
      }
    }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #lobby { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #hud { position: absolute; top: 10px; left: 10px; color: white; z-index: 50; }
        #mobileControls { position: absolute; bottom: 20px; left: 0; width: 100%; display: none; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 50; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        #joystickZone { width: 150px; height: 150px; }
    </style>
</head>
<body>
    <div id="lobby">
        <img id="profilePic" width="100" height="100" style="border-radius:50%;">
        <h1 id="username">Yükleniyor...</h1>
        <button id="createRoom">Oda Kur</button>
        <select id="timeSelect">
            <option value="300">5 Dakika</option>
            <option value="600">10 Dakika</option>
            <option value="900">15 Dakika</option>
            <option value="1500">25 Dakika</option>
            <option value="1800">30 Dakika</option>
        </select>
        <input id="joinInput" placeholder="Oda ID ile katıl">
        <button id="joinRoom">Katıl</button>
        <div id="roomList"></div>
    </div>

    <div id="hud">Skor: Mavi 0 - Kırmızı 0 | Süre: --</div>

    <div id="mobileControls">
        <div id="joystickZone"></div>
        <div>
            <div class="btn" id="passBtn">PAS</div>
            <div class="btn" id="shootBtn">ŞUT</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'cannon-es';
        import nipplejs from 'nipplejs';

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const user = Telegram.WebApp.initDataUnsafe.user || { id: 999, first_name: 'Misafir', photo_url: '' };
        document.getElementById('username').innerText = user.first_name || user.username || 'Misafir';
        document.getElementById('profilePic').src = user.photo_url || 'https://via.placeholder.com/100';

        const socket = io();

        // ==== THREE.JS SETUP ====
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x88ccff);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Işık
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(20, 40, 20);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // Saha (basit yeşil zemin + çizgiler + duvarlar)
        const fieldGeo = new THREE.PlaneGeometry(100, 60);
        const fieldMat = new THREE.MeshStandardMaterial({ color: 0x00aa00 });
        const field = new THREE.Mesh(fieldGeo, fieldMat);
        field.rotation.x = -Math.PI / 2;
        field.receiveShadow = true;
        scene.add(field);

        // Kale basit kutu
        const goalGeo = new THREE.BoxGeometry(20, 10, 5);
        const goalMat = new THREE.MeshStandardMaterial({ color: 0xffffff, wireframe: true });
        const goal1 = new THREE.Mesh(goalGeo, goalMat);
        goal1.position.set(0, 5, -35);
        scene.add(goal1);
        const goal2 = goal1.clone();
        goal2.position.z = 35;
        scene.add(goal2);

        // Duvarlar (top dışarı çıkmasın)
        const wallMat = new THREE.MeshStandardMaterial({ transparent: true, opacity: 0 });
        const wall1 = new THREE.Mesh(new THREE.BoxGeometry(110, 20, 5), wallMat);
        wall1.position.z = -33;
        scene.add(wall1);
        const wall2 = wall1.clone();
        wall2.position.z = 33;
        scene.add(wall2);
        const wall3 = new THREE.Mesh(new THREE.BoxGeometry(5, 20, 70), wallMat);
        wall3.position.x = -53;
        scene.add(wall3);
        const wall4 = wall3.clone();
        wall4.position.x = 53;
        scene.add(wall4);

        // ==== CANNON PHYSICS ====
        const world = new CANNON.World();
        world.gravity.set(0, -20, 0);
        world.broadphase = new CANNON.NaiveBroadphase();

        // Saha zemin fizik
        const groundBody = new CANNON.Body({ mass: 0 });
        groundBody.addShape(new CANNON.Box(new CANNON.Vec3(50, 0.1, 30)));
        groundBody.position.set(0, -0.1, 0);
        world.addBody(groundBody);

        // Top
        const ballMesh = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        scene.add(ballMesh);
        const ballBody = new CANNON.Body({ mass: 1 });
        ballBody.addShape(new CANNON.Sphere(1));
        ballBody.position.set(0, 5, 0);
        world.addBody(ballBody);

        // Oyuncu modeli (basit Mixamo karakter - koşma animasyonlu)
        const loader = new GLTFLoader();
        let playerMixer, playerModel;
        const players = {}; // { socketId: { mesh, body, mixer, team } }

        loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/Soldier.glb', (gltf) => {
            playerModel = gltf.scene;
            playerMixer = new THREE.AnimationMixer(playerModel);
            const runAction = playerMixer.clipAction(gltf.animations[1]); // Run animasyonu
            runAction.play();
        });

        // Kamera kontrol (PC için orbit, mobil için takip)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enablePan = false;
        camera.position.set(0, 20, 50);

        // Mobil kontrol
        if (Telegram.WebApp.platform !== 'unknown') {
            document.getElementById('mobileControls').style.display = 'flex';
            const manager = nipplejs.create({ zone: document.getElementById('joystickZone'), mode: 'static', position: { left: '50%', bottom: '50%' }, color: 'white' });
            let moveVec = new THREE.Vector3();
            manager.on('move', (evt, data) => {
                moveVec.set(data.vector.x, 0, -data.vector.y);
            });
            manager.on('end', () => moveVec.set(0,0,0));

            document.getElementById('shootBtn').addEventListener('touchstart', () => socket.emit('kick', { power: 20 }));
            document.getElementById('passBtn').addEventListener('touchstart', () => socket.emit('kick', { power: 8 }));
        }

        // Animasyon döngüsü
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            world.step(1/60, delta);

            // Top sync
            ballMesh.position.copy(ballBody.position);
            ballMesh.quaternion.copy(ballBody.quaternion);

            // Oyuncu hareket (basit örnek - kendi oyuncunu hareket ettir)
            if (myPlayerBody && moveVec.length() > 0) {
                const velocity = moveVec.clone().multiplyScalar(15);
                myPlayerBody.velocity.x = velocity.x;
                myPlayerBody.velocity.z = velocity.z;
                if (playerMixer) playerMixer.update(delta);
            }

            renderer.render(scene, camera);
        }
        animate();

        // ==== SOCKET.IO ====
        let myId, myTeam, myPlayerBody;
        socket.emit('joinLobby', { userId: user.id, username: user.first_name });

        document.getElementById('createRoom').onclick = () => {
            const time = document.getElementById('timeSelect').value;
            socket.emit('createRoom', { time });
        };

        document.getElementById('joinRoom').onclick = () => {
            const roomId = document.getElementById('joinInput').value;
            socket.emit('joinRoom', roomId);
        };

        socket.on('roomJoined', (data) => {
            document.getElementById('lobby').style.display = 'none';
            // Takım seçimi vs burada
        });

        socket.on('playerUpdate', (playersData) => {
            // Diğer oyuncuları sync et (basit pozisyon)
        });

        socket.on('kickBall', (force) => {
            // Topa yakınsa kuvvet uygula
            const direction = new CANNON.Vec3(); // kamera yönüne göre
            ballBody.applyImpulse(direction.scale(force), ballBody.position);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
