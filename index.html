<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Mələk</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{
  margin:0;
  background:#0e1621;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#17212b;
  padding:14px;
  font-weight:600;
  font-size:17px;
}
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:76%;
  padding:10px 14px;
  border-radius:18px;
  margin-bottom:8px;
  line-height:1.35;
  font-size:15px;
}
.in{background:#1f2c3a;align-self:flex-start}
.out{background:#4da3ff;color:#000;align-self:flex-end}

#typing{
  display:none;
  text-align:center;
  font-size:18px;
  color:#00eaff;
  opacity:.8;
  margin:6px 0;
}

footer{
  background:#17212b;
  padding:10px;
  display:flex;
  gap:8px;
}
input{
  flex:1;
  padding:12px 14px;
  border:none;
  border-radius:20px;
  font-size:15px;
  outline:none;
}
button{
  background:#4da3ff;
  border:none;
  padding:0 18px;
  border-radius:50%;
  font-size:16px;
  cursor:pointer;
}
</style>
</head>

<body>

<header id="title">Mələk</header>

<div id="chat"></div>
<div id="typing">yazır…</div>

<footer>
  <input id="input" placeholder="Mesaj yaz…" autocomplete="off">
  <button onclick="send()">➤</button>
</footer>

<script>
/* ===== Telegram fullscreen ===== */
if(window.Telegram?.WebApp){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

/* ===== User ===== */
const tgUser = Telegram?.WebApp?.initDataUnsafe?.user;
const userName = tgUser?.first_name || "Dost";

/* ===== Elements ===== */
const chat=document.getElementById("chat");
const input=document.getElementById("input");
const typing=document.getElementById("typing");
document.getElementById("title").innerText="Mələk • "+userName;

/* ===== Storage ===== */
let history = JSON.parse(localStorage.getItem("chatHistory")||"[]");

function save(){localStorage.setItem("chatHistory",JSON.stringify(history));}

/* ===== UI ===== */
function add(text,type,saveIt=true){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerText=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
  if(saveIt){
    history.push({role:type,text});
    save();
  }
}

/* ===== Load history ===== */
history.forEach(m=>add(m.text,m.role,false));

/* ===== Greeting once ===== */
if(!localStorage.getItem("greeted")){
  add(`Salam ${userName}. Buradayam.`,"in");
  localStorage.setItem("greeted","1");
}

/* ===== Queue ===== */
let queue=[],busy=false;

function send(){
  const t=input.value.trim();
  if(!t) return;
  input.value="";
  add(t,"out");
  queue.push(t);
  process();
}

async function process(){
  if(busy||!queue.length) return;
  busy=true;
  typing.style.display="block";

  const msg=queue.shift();
  const reply=await askAI(msg);

  typing.style.display="none";
  add(reply,"in");
  busy=false;
  setTimeout(process,250);
}

/* ===== AI ===== */
async function askAI(text){
  const last = history.slice(-6).map(m=>
    (m.role==="out"?"İstifadəçi: ":"Mələk: ")+m.text
  ).join("\n");

  const prompt = `
Sən Mələk-sən.
Dost kimi danış.
Qısa və normal cavab ver.
Özünü təqdim etmə.
Sahibindən danışma, ancaq soruşulsa de:
"Sahibim və məni kodlayan Xaliq Mustafayevdir. Telegram/Instagram: @xaliqmustafayev"

SÖHBƏT:
${last}

İstifadəçi: ${text}
`;

  try{
    const r=await fetch("https://text.pollinations.ai/"+encodeURIComponent(prompt),{cache:"no-store"});
    if(!r.ok) throw 1;
    return await r.text();
  }catch{
    return "Buradayam.";
  }
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});
</script>

</body>
</html>
