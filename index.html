<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Master Pro Scanner (Azərbaycanca)</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Rəng Palitrası */
        :root {
            --bg-dark: #1f2937;
            --surface-dark: #374151;
            --accent: #10b981; /* Yaşıl */
            --text-light: #f3f4f6;
            --text-muted: #9ca3af;
            --danger: #ef4444;
            --radius: 12px;
        }

        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-light); 
            margin: 0; 
            padding: 20px;
        }

        /* 1. Mərkəzləşdirmə Fix-i */
        .search-container { 
            max-width: 700px; 
            margin: 0 auto 40px; /* Ortaya gətirir */
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            text-align: center;
            align-items: center; /* Mərkəzləşdirir */
        }
        .search-title { 
            font-size: 2rem; 
            font-weight: 700; 
            color: var(--accent);
        }
        .input-group { 
            display: flex; 
            gap: 10px; 
            width: 100%; /* Tam eni istifadə edir */
        }
        input { 
            flex: 1; 
            padding: 15px; 
            border: 2px solid var(--surface-dark); 
            border-radius: var(--radius); 
            background: var(--surface-dark);
            color: var(--text-light);
            font-size: 16px; 
            outline: none; 
            transition: border-color 0.3s;
        }
        .btn { 
            padding: 15px 25px; 
            border: none; 
            border-radius: var(--radius); 
            cursor: pointer; 
            font-weight: 700; 
            color: var(--text-light); 
            transition: background-color 0.3s;
        }
        .btn-scan { 
            background: var(--accent); 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        /* Dashboard Grid */
        .dashboard { 
            display: none; 
            max-width: 1200px; 
            margin: 0 auto; 
            grid-template-columns: 1fr 1fr;
            gap: 25px; 
        }
        
        /* Cards & Details */
        .card { 
            background: var(--surface-dark); 
            border-radius: var(--radius); 
            padding: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        }
        .hero-card { 
            grid-column: 1 / -1; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
        }
        .car-image { 
            width: 40%; 
            max-height: 250px; /* Şəkil hündürlüyü tənzimləndi */
            object-fit: cover; 
            border-radius: var(--radius); 
            background: #4b5563;
        }
        
        /* Data Display */
        .check-list, .specs-grid { list-style: none; padding: 0; }
        .check-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid #4b5563; 
        }
        .status-checked { color: var(--accent); }
        .status-available { color: #3b82f6; }
        .spec-box { background: #4b5563; padding: 15px; border-radius: 8px; }
        .spec-title { font-size: 0.8rem; color: var(--text-muted); }
        .spec-val { font-weight: 600; font-size: 1.1rem; margin-top: 5px; }

        /* Scanner Modal Fix (Kameranın açılması üçün vacibdir) */
        #scanner-modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 1000; 
            display: none; 
            /* Flex-i əlavə etdik */
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #reader { 
            width: 100%; 
            max-width: 500px; 
            height: 350px; 
        }
    </style>
</head>
<body>

    <div class="search-container">
        <div class="search-title">VIN Master Pro</div>
        <div class="input-group">
            <input type="text" id="vinInput" placeholder="VIN kodu daxil edin (17 simvol)">
            <button class="btn btn-scan" onclick="openScanner()">
                <i class="fas fa-camera"></i> Skan et
            </button>
            <button class="btn" style="background: var(--surface-dark);" onclick="fetchData()">
                <i class="fas fa-search"></i> Axtar
            </button>
        </div>
    </div>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:var(--text-muted);">Məlumat bazaları yoxlanılır...</p>
    </div>

    <div class="dashboard" id="dashboard">
        </div>

    <div id="scanner-modal" style="display: none;">
        <div class="close-scan" onclick="closeScanner()">&times;</div>
        <div id="reader"></div>
        <p class="camera-info">Kodu kameranın mərkəzinə tutun. Avtomatik oxunacaq.</p>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // Render Linkiniz (lazım gələrsə yeniləyin)
        const API = "https://saskioyunu.onrender.com/api/search"; 
        let html5QrcodeScanner = null;

        async function fetchData(code = null) {
            const vin = code || document.getElementById('vinInput').value.trim();
            if (vin.length !== 17) return alert("VIN kod 17 simvol olmalıdır!");

            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                const res = await fetch(`${API}?q=${vin}`);
                const json = await res.json();

                if (json.success) {
                    renderDashboard(json.data, vin);
                } else {
                    alert("Axtarış uğursuz oldu: " + json.message);
                }
            } catch (error) {
                alert("Server bağlantı xətası baş verdi. Render serveri aktiv olduğundan əmin olun.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // TƏRCÜMƏ SİNXRONİZASİYASI VƏ GÖRÜNTÜLƏNMƏ FİKSİ
        function renderDashboard(data, vin) {
            const dash = document.getElementById('dashboard');
            const summary = data.summary; // Azərbaycanca açarlar gəlir
            const specs = data.specs;     // Azərbaycanca açarlar gəlir
            const recalls = data.recalls; 
            const imageUrl = data.image || 'https://via.placeholder.com/400x200?text=Şəkil+Tapılmadı';

            let recallsHTML = recalls.length > 0 
                ? recalls.map(r => `
                    <div class="recall-item">
                        <div class="recall-title"><i class="fas fa-exclamation-triangle"></i> Komponent: ${r.komponent || 'N/A'}</div>
                        <div class="recall-desc">Xülasə (EN): ${r.xülasə ? r.xülasə.substring(0, 150) + '...' : 'Təfərrüat yoxdur.'}</div>
                    </div>`).join('')
                : '<p style="color:var(--accent)"><i class="fas fa-check-circle"></i> Açıq Zavod Xətası Tapılmadı.</p>';

            // 1. Report Summary (Hesabat Yoxlanışları)
            const summaryHTML = Object.entries(summary).map(([key, val]) => `
                <li class="check-item">
                    <span class="check-label">${key}</span> 
                    <span class="check-status status-${val.includes('Uğurlu') || val.includes('Mövcud') ? 'checked' : 'available'}">
                        ${val}
                    </span>
                </li>
            `).join('');

            // 2. Specs Details (Texniki Məlumat)
            const specsHTML = Object.entries(specs).map(([key, val]) => `
                <div class="spec-box">
                    <div class="spec-title">${key}</div>
                    <div class="spec-val">${val}</div>
                </div>
            `).join('');

            dash.innerHTML = `
                <div class="card hero-card">
                    <img src="${imageUrl}" alt="${specs.Marka || ''} Şəkli" class="car-image">
                    <div class="hero-details">
                        <span class="vin-badge"><i class="fas fa-fingerprint"></i> ${vin}</span>
                        <h1 class="car-title">${specs.Marka || 'Məlumat Yoxdur'} ${specs.Model || ''}</h1>
                        <p style="color:var(--text-muted)">Buraxılış İli: ${specs["Buraxılış İli"] || 'N/A'}</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" style="color:var(--text-light);"><i class="fas fa-clipboard-check"></i> Hesabat Yoxlanışları</div>
                    <ul class="check-list">${summaryHTML}</ul>
                </div>

                <div class="card">
                    <div class="card-header" style="color:var(--text-light);"><i class="fas fa-cogs"></i> Texniki Məlumat</div>
                    <div class="specs-grid">${specsHTML}</div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header" style="color:var(--danger)"><i class="fas fa-bullhorn"></i> Zavod Xətaları</div>
                    ${recallsHTML}
                </div>
            `;

            dash.style.display = 'grid';
        }

        // KAMERA FİKSİ: Kamera icazəsi və açılması
        function openScanner() {
            // Modal-ı görünən edirik
            document.getElementById('scanner-modal').style.display = 'flex';
            
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: 250 };
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, // Arxa kameranı prioritet edir
                config,
                (decodedText) => {
                    // Uğurla oxunduqda
                    closeScanner();
                    document.getElementById('vinInput').value = decodedText;
                    fetchData(decodedText);
                }
            ).catch(err => {
                // Kamera icazəsi və ya cihaz tapılmadıqda
                alert("Kamera başlatıla bilmədi. Zəhmət olmasa, brauzerinizdə kamera icazəsini yoxlayın və ya kodu əl ilə daxil edin.");
                console.error(err);
                closeScanner();
            });
        }

        function closeScanner() {
            document.getElementById('scanner-modal').style.display = 'none';
            if(html5QrcodeScanner && html5QrcodeScanner.isscanning) {
                html5QrcodeScanner.stop().catch(err => console.error("Scanner stop failed:", err));
            }
        }
    </script>
</body>
</html>
