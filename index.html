<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Master Pro (Final Version)</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Glassmorphism/Dark Theme */
        :root {
            --bg-dark: #1f2937;
            --surface-blur: rgba(55, 65, 81, 0.7); 
            --accent: #10b981; 
            --text-light: #f3f4f6;
            --text-muted: #9ca3af;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 16px;
        }

        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-light); 
            margin: 0; 
            padding: 40px 20px;
        }

        .search-container { 
            max-width: 800px; 
            margin: 0 auto 50px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            align-items: center; 
            padding: 20px;
        }
        .search-title { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: var(--accent);
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }
        .input-group { 
            display: flex; 
            gap: 10px; 
            width: 100%; 
            max-width: 650px;
        }
        input { 
            flex: 1; 
            padding: 16px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: var(--radius); 
            background: var(--surface-blur);
            backdrop-filter: blur(8px); 
            color: var(--text-light);
            font-size: 16px; 
            transition: all 0.3s ease-in-out;
        }
        .btn { 
            padding: 16px 20px; 
            border: none; 
            border-radius: var(--radius); 
            cursor: pointer; 
            font-weight: 700; 
            color: var(--text-light); 
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-scan { background: var(--accent); }
        .btn-search { background: #3b82f6; }

        .dashboard { 
            display: none; 
            max-width: 1200px; 
            margin: 0 auto; 
            grid-template-columns: 1fr 1fr;
            gap: 30px; 
            animation: fadeIn 0.8s ease-out;
        }
        
        .card { 
            background: var(--surface-blur); 
            border-radius: var(--radius); 
            padding: 30px; 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease-in-out;
        }
        
        .check-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .status-checked { color: var(--accent); }
        .status-danger { color: var(--danger); }
        .status-warning { color: var(--warning); }
        
        .specs-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .spec-box { 
            background: rgba(75, 85, 99, 0.6); 
            padding: 15px; 
            border-radius: 8px; 
            transition: background 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="search-container">
        <div class="search-title">VIN Master Pro Scanner</div>
        <div class="input-group">
            <input type="text" id="vinInput" placeholder="VIN kodu daxil edin (17 simvol)">
            <button class="btn btn-scan" onclick="openScanner()">
                <i class="fas fa-camera"></i> Skan et
            </button>
            <button class="btn btn-search" onclick="fetchData()">
                <i class="fas fa-search"></i> Axtar
            </button>
        </div>
    </div>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:var(--text-muted);">Məlumat bazaları yoxlanılır...</p>
    </div>

    <div class="dashboard" id="dashboard">
        </div>

    <div id="scanner-modal" style="display: none;">
        <div class="close-scan" onclick="closeScanner()">&times;</div>
        <div id="reader"></div>
        <p class="camera-info">Kodu kameranın mərkəzinə tutun. Avtomatik oxunacaq.</p>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const API = "https://saskioyunu.onrender.com/api/search"; 
        let html5QrcodeScanner = null;

        async function fetchData(code = null) {
            const vin = code || document.getElementById('vinInput').value.trim();
            if (vin.length !== 17) return alert("VIN kod 17 simvol olmalıdır!");

            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                const res = await fetch(`${API}?q=${vin}`);
                const json = await res.json();

                if (json.success) {
                    renderDashboard(json.data, vin);
                } else {
                    alert("Axtarış uğursuz oldu: " + json.message);
                }
            } catch (error) {
                alert("Server bağlantı xətası baş verdi. Serverin aktiv olduğundan əmin olun.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function getStatusClass(value) {
            if (value.includes('Problem Tapıldı') || value.includes('Hərrac/Zərər')) return 'status-danger';
            if (value.includes('Ödənişli bazada') || value.includes('Yoxlama Tələb Olunur')) return 'status-warning';
            if (value.includes('Mövcuddur') || value.includes('Uğurlu') || value.includes('Tapılmadı')) return 'status-checked';
            return '';
        }

        function renderDashboard(data, vin) {
            const dash = document.getElementById('dashboard');
            const summary = data.summary;
            const specs = data.specs;
            const recalls = data.recalls; 
            const imageUrl = data.image || 'https://via.placeholder.com/400x200?text=Şəkil+Tapılmadı';

            // Zavod Xətaları (Recalls)
            let recallsHTML = recalls.length > 0 
                ? recalls.map(r => `
                    <div class="recall-item">
                        <div class="recall-title"><i class="fas fa-exclamation-triangle"></i> Komponent: ${r.komponent || 'N/A'}</div>
                        <div class="recall-desc">Xülasə (EN): ${r.xülasə ? r.xülasə.substring(0, 150) + '...' : 'Təfərrüat yoxdur.'}</div>
                    </div>`).join('')
                : '<p style="color:var(--accent)"><i class="fas fa-check-circle"></i> Açıq Zavod Xətası Tapılmadı.</p>';

            // 1. Report Summary (Hesabat Yoxlanışları)
            const summaryHTML = Object.entries(summary).map(([key, val]) => `
                <li class="check-item">
                    <span class="check-label ${getStatusClass(val)}">${key}</span> 
                    <span class="check-status ${getStatusClass(val)}">
                        ${val}
                    </span>
                </li>
            `).join('');

            // 2. Specs Details (Texniki Məlumat)
            const specsHTML = Object.entries(specs).map(([key, val]) => `
                <div class="spec-box">
                    <div class="spec-title">${key}</div>
                    <div class="spec-val">${val}</div>
                </div>
            `).join('');


            dash.innerHTML = `
                <div class="card hero-card">
                    <img src="${imageUrl}" alt="${specs.Marka || ''} Şəkli" class="car-image">
                    <div class="hero-details">
                        <span class="vin-badge"><i class="fas fa-fingerprint"></i> ${vin}</span>
                        <h1 class="car-title">${specs.Marka || 'Məlumat Yoxdur'} ${specs.Model || ''}</h1>
                        <p style="color:var(--text-muted)">Buraxılış İli: ${specs["Buraxılış İli"] || 'N/A'}</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" style="color:var(--text-light);"><i class="fas fa-clipboard-check"></i> Hesabat Yoxlanışları</div>
                    <ul class="check-list">${summaryHTML}</ul>
                </div>

                <div class="card">
                    <div class="card-header" style="color:var(--text-light);"><i class="fas fa-cogs"></i> Texniki Məlumat</div>
                    <div class="specs-grid">${specsHTML}</div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header" style="color:var(--danger)"><i class="fas fa-bullhorn"></i> Zavod Xətaları</div>
                    ${recallsHTML}
                </div>
            `;

            dash.style.display = 'grid';
        }

        // KAMERA İNİSİALİZASİYASI
        function openScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: 250 };
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config,
                (decodedText) => {
                    closeScanner();
                    document.getElementById('vinInput').value = decodedText;
                    fetchData(decodedText);
                }
            ).catch(err => {
                alert("Kamera başlatıla bilmədi. İcazələri yoxlayın.");
                closeScanner();
            });
        }

        function closeScanner() {
            document.getElementById('scanner-modal').style.display = 'none';
            if(html5QrcodeScanner && html5QrcodeScanner.isscanning) {
                html5QrcodeScanner.stop().catch(err => console.error("Scanner stop failed:", err));
            }
        }
    </script>
</body>
</html>
