<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FullSong Y√ºkl…ôyici Bot</title>
    <style>
        /* ... (Stil Kodlarƒ± eynidir) ... */
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #f4f6f9; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; }
        h1 { color: #0088cc; margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #0088cc; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #0077b3; }
        #auth-status { margin-top: 15px; font-weight: bold; }
        #download-form { display: none; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéµ FullSong Bot Y√ºkl…ôyici</h1>
        
        <script async src="https://telegram.org/js/telegram-widget.js?22" 
                data-telegram-login="fullsongbot" 
                data-size="large" 
                data-auth-url="javascript:onTelegramAuth(user)" 
                data-request-access="write"></script>

        <div id="auth-status">Z…ôhm…ôt olmasa, Telegram il…ô daxil olun.</div>

        <div id="download-form">
            <p id="welcome-message">Xo≈ü g…ôlmisiniz!</p>
            <input type="text" id="query-input" placeholder="Mahnƒ± adƒ± v…ô ya YouTube linki daxil edin" required>
            <button onclick="sendDownloadRequest()">Y√ºkl…ôm…ôni Ba≈ülat</button>
            <div id="status-message" style="margin-top: 15px; color: green;"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        const RENDER_API_URL = "https://fullsongnodejs.onrender.com"; 
        let userId = null; 
        
        function onTelegramAuth(user) {
            userId = user.id;
            const firstName = user.first_name || "ƒ∞stifad…ô√ßi";
            
            document.getElementById('auth-status').style.display = 'none';
            document.getElementById('download-form').style.display = 'block';
            document.getElementById('welcome-message').innerText = `Xo≈ü g…ôlmisiniz, ${firstName}! Musiqi sifari≈ü edin.`;
            console.log("ƒ∞stifad…ô√ßi ID-si:", userId);
        }

        function checkAutoLogin() {
            // METOD 1: TELEGRAM WEBACTUAL APP SDK ƒ∞L∆è YOXLAMA (∆èn etibarlƒ± yol)
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                onTelegramAuth({ id: tgUser.id, first_name: tgUser.first_name });
                window.Telegram.WebApp.ready();
                return true;
            }

            // METOD 2: URL PARAMETRL∆èRƒ∞ ƒ∞L∆è YOXLAMA (K√∂hn…ô metod)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('id') && urlParams.has('hash')) {
                const user = { id: urlParams.get('id'), first_name: urlParams.get('first_name') };
                onTelegramAuth(user);
                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }
            return false;
        }

        function sendDownloadRequest() {
            const query = document.getElementById('query-input').value.trim();
            const statusDiv = document.getElementById('status-message');

            if (!userId) {
                statusDiv.style.color = 'red';
                statusDiv.innerText = 'Xahi≈ü edirik, …ôvv…ôlc…ô Telegram il…ô daxil olun.';
                return;
            }

            if (!query) {
                statusDiv.style.color = 'red';
                statusDiv.innerText = 'Z…ôhm…ôt olmasa, mahnƒ± adƒ± v…ô ya link daxil edin.';
                return;
            }

            statusDiv.style.color = 'orange';
            statusDiv.innerText = 'Sifari≈ü q…ôbul edildi. Bot qƒ±sa zamanda siz…ô Telegram-da cavab g√∂nd…ôr…ôc…ôk...';
            
            const apiEndpoint = `${RENDER_API_URL}/process-request`;
            
            fetch(apiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: userId, query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.style.color = 'green';
                    statusDiv.innerText = 'Sifari≈ü uƒüurla g√∂nd…ôrildi! Telegramƒ±nƒ±zƒ± yoxlayƒ±n.';
                } else {
                    statusDiv.style.color = 'red';
                    statusDiv.innerText = `Sifari≈ü x…ôtasƒ±: ${data.message || 'Bilinm…ôy…ôn x…ôta'}`;
                }
            })
            .catch(error => {
                console.error('API Error:', error);
                statusDiv.style.color = 'red';
                statusDiv.innerText = 'Serverl…ô …ôlaq…ô qurulark…ôn problem yarandƒ± (Render Yuxu Rejimind…ô ola bil…ôr).';
            });
        }

        checkAutoLogin();
    </script>

</body>
</html>
