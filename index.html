<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Backrooms Hunt - Multiplayer Horror</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/TextureLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>
    <style>
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: #fff;
            user-select: none;
        }

        /* LOADING SCREEN */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-logo {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #FF6B00, #FFD700, #00FFAA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            text-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #FF6B00, #FFD700);
            width: 0%;
            transition: width 0.3s;
            border-radius: 2px;
        }

        .loading-text {
            color: #888;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* ORIENTATION WARNING */
        #orientationWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }

        @media (orientation: portrait) {
            #orientationWarning {
                display: flex;
            }
        }

        .orientation-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #FFD700;
        }

        /* MAIN CONTAINERS */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%);
            z-index: 100;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* MAIN MENU */
        .main-menu {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .game-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .title-main {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, #FFD700, #FF6B00, #FF0080);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .title-sub {
            font-size: 1rem;
            color: #aaa;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: #FFD700;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
        }

        .menu-btn.primary {
            background: linear-gradient(45deg, #FF6B00, #FFD700);
            color: #000;
            border: none;
            font-weight: 700;
        }

        .menu-btn.primary:hover {
            box-shadow: 0 10px 25px rgba(255, 107, 0, 0.4);
        }

        .menu-btn-icon {
            font-size: 1.5rem;
        }

        /* LOBBY */
        .lobby-container {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #00FFAA;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 255, 170, 0.3);
        }

        .room-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .room-code {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: #00FFAA;
            letter-spacing: 3px;
        }

        .room-name {
            color: #ccc;
            font-size: 1.2rem;
        }

        .player-count {
            background: rgba(0, 255, 170, 0.1);
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .player-card.host {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .player-card.ready {
            border-color: #00FFAA;
            background: rgba(0, 255, 170, 0.05);
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #333, #555);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .player-status {
            font-size: 0.8rem;
            color: #888;
        }

        .lobby-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* BUTTONS */
        .btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00FFAA, #00CC88);
            color: #000;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 255, 170, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #FF4757, #FF6B81);
            color: #fff;
        }

        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3);
        }

        /* GAME UI */
        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .game-ui > * {
            pointer-events: auto;
        }

        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            min-width: 200px;
        }

        .role-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .role-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .role-icon.hunter {
            background: linear-gradient(45deg, #FF4757, #FF6B81);
            animation: pulse-red 1s infinite;
        }

        .role-icon.runner {
            background: linear-gradient(45deg, #00FFAA, #00CC88);
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .role-text {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .game-timer {
            font-size: 2.5rem;
            font-weight: 900;
            color: #FFD700;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .players-list {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            min-width: 250px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        .player-item.hunter {
            border-left: 3px solid #FF4757;
        }

        .player-item.runner {
            border-left: 3px solid #00FFAA;
        }

        .player-health {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #00FFAA, #00CC88);
            transition: width 0.3s;
        }

        /* PHOTO MECHANIC */
        .photo-ui {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .photo-frame {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #FFD700;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            max-width: 400px;
            width: 90vw;
        }

        .photo-preview {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .photo-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-btn.capture {
            background: linear-gradient(45deg, #FF4757, #FF6B81);
            color: white;
        }

        .photo-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* MOBILE CONTROLS */
        .mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            align-items: flex-end;
        }

        .joystick-area {
            width: 140px;
            height: 140px;
            position: relative;
            touch-action: none;
        }

        .joystick-bg {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 70%);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .joystick-thumb {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #FF6B00, #FFD700);
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.5);
            opacity: 0;
            transition: all 0.3s;
        }

        .action-btn.show {
            opacity: 1;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .action-btn.hunt {
            background: linear-gradient(45deg, #FF4757, #FF6B81);
        }

        .action-btn.photo {
            background: linear-gradient(45deg, #00FFAA, #00CC88);
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 3px solid;
            border-radius: 20px;
            padding: 30px 40px;
            text-align: center;
            font-size: 1.5rem;
            max-width: 80%;
            display: none;
            z-index: 1000;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-color: #00FFAA;
            color: #00FFAA;
        }

        .notification.warning {
            border-color: #FFD700;
            color: #FFD700;
        }

        .notification.error {
            border-color: #FF4757;
            color: #FF4757;
        }

        .notification.info {
            border-color: #00AAFF;
            color: #00AAFF;
        }

        /* GAME OVER SCREEN */
        .game-over {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(30px);
            border: 3px solid #FFD700;
            border-radius: 30px;
            padding: 50px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }

        .result-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .result-icon.win {
            color: #00FFAA;
            text-shadow: 0 0 30px rgba(0, 255, 170, 0.5);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .result-icon.lose {
            color: #FF4757;
            text-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }

        .result-title {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #FFD700, #FF6B00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: #FFD700;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #FF6B00, #FFD700);
            border-radius: 5px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-menu {
                padding: 30px 20px;
            }
            
            .title-main {
                font-size: 2.5rem;
            }
            
            .lobby-container {
                padding: 20px;
            }
            
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-controls {
                padding: 0 20px;
            }
            
            .joystick-area {
                width: 120px;
                height: 120px;
            }
            
            .action-btn {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .game-over {
                padding: 30px 20px;
            }
            
            .result-title {
                font-size: 2.2rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
        }

        /* CROSSHAIR */
        .crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 10;
        }

        .crosshair-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        .crosshair-inner::before,
        .crosshair-inner::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        .crosshair-inner::before {
            width: 2px;
            height: 10px;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .crosshair-inner::after {
            width: 10px;
            height: 2px;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <!-- ORIENTATION WARNING -->
    <div id="orientationWarning">
        <div class="orientation-icon">üì±</div>
        <h2>L√ºtfen Cihazƒ±nƒ±zƒ± √áevirin</h2>
        <p>Oyun en iyi yatay modda √ßalƒ±≈üƒ±r</p>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loadingScreen">
        <div class="loading-logo">BACKROOMS HUNT</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingText">Y√ºkleniyor...</div>
    </div>

    <!-- SCREENS -->
    <div id="mainMenu" class="screen active">
        <div class="main-menu">
            <div class="game-title">
                <div class="title-main">BACKROOMS HUNT</div>
                <div class="title-sub">Multiplayer Horror Experience</div>
            </div>
            <div class="menu-buttons">
                <button class="menu-btn primary" onclick="createRoom()">
                    <span class="menu-btn-icon">üéÆ</span>
                    OYUN BA≈ûLAT
                </button>
                <button class="menu-btn" onclick="joinRoom()">
                    <span class="menu-btn-icon">üîó</span>
                    ODAYA KATIL
                </button>
                <button class="menu-btn" onclick="quickMatch()">
                    <span class="menu-btn-icon">‚ö°</span>
                    HIZLI E≈ûLE≈ûME
                </button>
                <button class="menu-btn" onclick="showHowToPlay()">
                    <span class="menu-btn-icon">‚ùì</span>
                    NASIL OYNANIR
                </button>
            </div>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="lobbyScreen" class="screen">
        <div class="lobby-container">
            <div class="lobby-header">
                <div class="room-info">
                    <div class="room-code" id="roomCode">---</div>
                    <div class="room-name" id="roomName">Oda ƒ∞smi</div>
                </div>
                <div class="player-count">
                    <span id="playerCount">0</span>/<span id="maxPlayers">10</span> Oyuncu
                </div>
            </div>
            
            <div class="players-grid" id="playersGrid">
                <!-- Player cards will be added here -->
            </div>
            
            <div class="lobby-controls">
                <button class="btn btn-primary" onclick="toggleReady()" id="readyBtn">
                    <span>üë§</span>
                    HAZIR OL
                </button>
                <button class="btn btn-secondary" onclick="startGame()" id="startBtn">
                    <span>üéÆ</span>
                    OYUNU BA≈ûLAT
                </button>
                <button class="btn btn-danger" onclick="leaveLobby()">
                    <span>üö™</span>
                    ODADAN √áIK
                </button>
            </div>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="gameUI" class="game-ui" style="display: none;">
        <!-- CROSSHAIR -->
        <div class="crosshair">
            <div class="crosshair-inner"></div>
        </div>
        
        <!-- HUD -->
        <div class="game-hud">
            <div class="hud-panel">
                <div class="role-display">
                    <div class="role-icon runner" id="roleIcon">üèÉ</div>
                    <div class="role-text" id="roleText">KA√áAN</div>
                </div>
                <div class="game-timer" id="gameTimer">05:00</div>
            </div>
            
            <div class="players-list" id="playersList">
                <!-- Player list will be added here -->
            </div>
        </div>
        
        <!-- PHOTO UI -->
        <div class="photo-ui" id="photoUI" style="display: none;">
            <div class="photo-frame">
                <div class="photo-preview" id="photoPreview"></div>
                <div class="photo-buttons">
                    <button class="photo-btn capture" onclick="capturePhoto()">üì∏ FOTOƒûRAF √áEK</button>
                    <button class="photo-btn cancel" onclick="cancelPhoto()">‚ùå ƒ∞PTAL</button>
                </div>
            </div>
        </div>
        
        <!-- MOBILE CONTROLS -->
        <div class="mobile-controls">
            <div class="joystick-area" id="joystickArea">
                <div class="joystick-bg"></div>
                <div class="joystick-thumb" id="joystickThumb"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn hunt" id="huntBtn" onclick="huntAction()" style="display: none;">üéØ</button>
                <button class="action-btn photo" id="photoBtn" onclick="togglePhotoMode()">üì∏</button>
                <button class="action-btn" id="jumpBtn" onclick="jumpAction()">‚¨ÜÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameOverScreen" class="screen">
        <div class="game-over">
            <div class="result-icon win" id="resultIcon">üèÜ</div>
            <div class="result-title" id="resultTitle">OYUN SONU</div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="statTime">00:00</div>
                    <div class="stat-label">S√úRE</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statPhotos">0</div>
                    <div class="stat-label">FOTOƒûRAF</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statHunts">0</div>
                    <div class="stat-label">AV</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statXP">+0</div>
                    <div class="stat-label">XP</div>
                </div>
            </div>
            
            <div class="lobby-controls">
                <button class="btn btn-primary" onclick="playAgain()">
                    <span>üîÑ</span>
                    TEKRAR OYNA
                </button>
                <button class="btn btn-secondary" onclick="returnToLobby()">
                    <span>üè†</span>
                    LOBBY'E D√ñN
                </button>
                <button class="btn btn-danger" onclick="returnToMenu()">
                    <span>üö™</span>
                    √áIKI≈û
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div class="notification" id="notification"></div>

    <!-- GAME CANVAS -->
    <div id="gameContainer"></div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        const tg = window.Telegram.WebApp;
        const SERVER_URL = 'wss://backrooms-hunt.onrender.com';
        
        let ws = null;
        let playerId = null;
        let playerName = 'Player';
        let currentRoom = null;
        
        let gameState = {
            screen: 'mainMenu',
            isReady: false,
            isHost: false,
            isHunter: false,
            isAlive: true,
            gameActive: false,
            gameTime: 300,
            players: {},
            playerStats: {
                photosTaken: 0,
                hunts: 0,
                timeSurvived: 0,
                xp: 0
            }
        };
        
        // Three.js variables
        let scene, camera, renderer, controls;
        let player, playerBox;
        let maze = [];
        let otherPlayers = {};
        let photos = [];
        
        // Control variables
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let mouseX = 0, mouseY = 0;
        let moveSpeed = 0.12;
        let isPhotoMode = false;
        
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingText = document.getElementById('loadingText');
        const screens = {
            mainMenu: document.getElementById('mainMenu'),
            lobbyScreen: document.getElementById('lobbyScreen'),
            gameOverScreen: document.getElementById('gameOverScreen')
        };
        const gameUI = document.getElementById('gameUI');
        const notification = document.getElementById('notification');
        const gameContainer = document.getElementById('gameContainer');

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initGame();
        });

        async function initGame() {
            try {
                // Initialize Telegram WebApp
                tg.expand();
                tg.requestFullscreen();
                tg.enableClosingConfirmation();
                
                // Setup back button
                tg.BackButton.show();
                tg.BackButton.onClick(handleBackButton);
                
                // Generate player ID
                playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                playerName = tg.initDataUnsafe?.user?.first_name || 'Player' + Math.floor(Math.random() * 1000);
                
                updateLoading(20, 'Telegram baƒülantƒ±sƒ± kuruluyor...');
                
                // Connect to WebSocket server
                await connectWebSocket();
                
                updateLoading(40, 'Oyun motoru y√ºkleniyor...');
                
                // Initialize Three.js (light version)
                initThreeJS();
                
                updateLoading(60, 'Oyun d√ºnyasƒ± hazƒ±rlanƒ±yor...');
                
                // Create initial scene (will be replaced by game)
                createSimpleScene();
                
                updateLoading(80, 'Kontroller ayarlanƒ±yor...');
                
                // Setup controls
                setupControls();
                
                updateLoading(100, 'Hazƒ±r!');
                
                // Hide loading screen
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }, 500);
                
                // Start animation loop
                animate();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Oyun ba≈ülatƒ±lamadƒ±: ' + error.message, 'error');
            }
        }

        function updateLoading(percent, text) {
            loadingProgress.style.width = percent + '%';
            loadingText.textContent = text;
        }

        // ==================== WEBSOCKET ====================
        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                ws = new WebSocket(SERVER_URL);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connected');
                    sendMessage({
                        type: 'init',
                        playerId: playerId,
                        playerName: playerName
                    });
                    resolve();
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (error) {
                        console.error('Message parse error:', error);
                    }
                };
                
                ws.onclose = () => {
                    console.log('‚ùå WebSocket disconnected');
                    showNotification('Sunucu baƒülantƒ±sƒ± kesildi. Yeniden baƒülanƒ±lƒ±yor...', 'error');
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    reject(error);
                };
            });
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.warn('WebSocket not connected');
            }
        }

        // ==================== SERVER MESSAGE HANDLER ====================
        function handleServerMessage(data) {
            switch(data.type) {
                case 'initSuccess':
                    console.log('‚úÖ Player initialized:', data.playerId);
                    break;
                    
                case 'roomCreated':
                    handleRoomCreated(data);
                    break;
                    
                case 'roomJoined':
                    handleRoomJoined(data);
                    break;
                    
                case 'playerJoined':
                    handlePlayerJoined(data);
                    break;
                    
                case 'playerLeft':
                    handlePlayerLeft(data);
                    break;
                    
                case 'playerReady':
                    handlePlayerReady(data);
                    break;
                    
                case 'gameStarting':
                    handleGameStarting(data);
                    break;
                    
                case 'gameUpdate':
                    handleGameUpdate(data);
                    break;
                    
                case 'playerPosition':
                    handlePlayerPosition(data);
                    break;
                    
                case 'playerCaptured':
                    handlePlayerCaptured(data);
                    break;
                    
                case 'photoTaken':
                    handlePhotoTaken(data);
                    break;
                    
                case 'gameEnded':
                    handleGameEnded(data);
                    break;
                    
                case 'error':
                    showNotification(data.message, 'error');
                    break;
            }
        }

        // ==================== ROOM MANAGEMENT ====================
        function createRoom() {
            sendMessage({
                type: 'createRoom',
                playerId: playerId,
                playerName: playerName,
                roomName: `${playerName}'s Hunt`,
                maxPlayers: 10,
                gameTime: 5
            });
        }

        function joinRoom() {
            const roomCode = prompt('Oda kodunu girin:');
            if (roomCode && roomCode.trim().length === 6) {
                sendMessage({
                    type: 'joinRoom',
                    playerId: playerId,
                    playerName: playerName,
                    roomCode: roomCode.toUpperCase()
                });
            }
        }

        function quickMatch() {
            sendMessage({
                type: 'quickMatch',
                playerId: playerId,
                playerName: playerName
            });
            showNotification('Hƒ±zlƒ± e≈üle≈üme aranƒ±yor...', 'info');
        }

        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            sendMessage({
                type: 'setReady',
                playerId: playerId,
                isReady: gameState.isReady
            });
            
            const readyBtn = document.getElementById('readyBtn');
            readyBtn.innerHTML = gameState.isReady ? 
                '<span>üë§</span> HAZIR DEƒûƒ∞L' : 
                '<span>üë§</span> HAZIR OL';
        }

        function startGame() {
            if (gameState.isHost) {
                sendMessage({
                    type: 'startGame',
                    playerId: playerId
                });
            }
        }

        function leaveLobby() {
            sendMessage({
                type: 'leaveRoom',
                playerId: playerId
            });
            showScreen('mainMenu');
        }

        // ==================== ROOM EVENT HANDLERS ====================
        function handleRoomCreated(data) {
            gameState.isHost = true;
            gameState.currentRoom = data.roomCode;
            
            document.getElementById('roomCode').textContent = data.roomCode;
            document.getElementById('roomName').textContent = data.room.name;
            document.getElementById('maxPlayers').textContent = data.room.maxPlayers;
            
            updatePlayersList(data.players);
            
            const startBtn = document.getElementById('startBtn');
            startBtn.style.display = gameState.isHost ? 'flex' : 'none';
            
            showScreen('lobbyScreen');
            showNotification('Oda olu≈üturuldu!', 'success');
        }

        function handleRoomJoined(data) {
            gameState.currentRoom = data.roomCode;
            gameState.isHost = data.players[playerId]?.isHost || false;
            
            document.getElementById('roomCode').textContent = data.roomCode;
            document.getElementById('roomName').textContent = data.room.name;
            document.getElementById('maxPlayers').textContent = data.room.maxPlayers;
            
            updatePlayersList(data.players);
            
            const startBtn = document.getElementById('startBtn');
            startBtn.style.display = gameState.isHost ? 'flex' : 'none';
            
            showScreen('lobbyScreen');
            showNotification('Odaya katƒ±ldƒ±nƒ±z!', 'success');
        }

        function handlePlayerJoined(data) {
            updatePlayersList(data.players);
            showNotification(`${data.playerName} odaya katƒ±ldƒ±`, 'info');
        }

        function handlePlayerLeft(data) {
            updatePlayersList(data.players);
            showNotification(`${data.playerName} odadan ayrƒ±ldƒ±`, 'warning');
        }

        function handlePlayerReady(data) {
            updatePlayersList(data.players);
        }

        function updatePlayersList(playersData) {
            gameState.players = playersData;
            
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            
            Object.values(playersData).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.isHost ? 'host' : ''} ${player.isReady ? 'ready' : ''}`;
                playerCard.innerHTML = `
                    <div class="player-avatar">${player.isHost ? 'üëë' : 'üë§'}</div>
                    <div class="player-name">${player.name}</div>
                    <div class="player-status">${player.isReady ? 'Hazƒ±r' : 'Bekliyor'}</div>
                `;
                playersGrid.appendChild(playerCard);
            });
            
            document.getElementById('playerCount').textContent = Object.keys(playersData).length;
        }

        // ==================== GAME EVENT HANDLERS ====================
        function handleGameStarting(data) {
            gameState.gameActive = true;
            gameState.isHunter = data.isHunter;
            gameState.gameTime = data.gameTime || 300;
            gameState.players = data.players;
            
            // Start 3D game
            start3DGame();
            
            // Update UI
            updateGameUI();
            startGameTimer();
            
            showScreen('game');
            showNotification(gameState.isHunter ? 
                'üëπ AVCI olarak ba≈üladƒ±n!' : 
                'üèÉ KA√áAN olarak ba≈üladƒ±n!', 'success');
            
            // Haptic feedback
            if (tg.isVersionAtLeast('6.1')) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
        }

        function handleGameUpdate(data) {
            if (data.timeRemaining !== undefined) {
                gameState.gameTime = data.timeRemaining;
                updateTimer();
            }
            
            if (data.gameState) {
                // Update game state
            }
        }

        function handlePlayerPosition(data) {
            if (otherPlayers[data.playerId]) {
                otherPlayers[data.playerId].position.set(
                    data.position.x,
                    data.position.y,
                    data.position.z
                );
                otherPlayers[data.playerId].rotation.set(
                    data.rotation.x,
                    data.rotation.y,
                    data.rotation.z
                );
            }
        }

        function handlePlayerCaptured(data) {
            if (data.hunterId === playerId) {
                gameState.playerStats.hunts++;
                showNotification('üéØ Bir avcƒ± yakaladƒ±n!', 'success');
            }
            
            if (data.runnerId === playerId) {
                gameState.isAlive = false;
                showNotification('üíÄ Yakalandƒ±n!', 'error');
            }
            
            updatePlayersHUD();
        }

        function handlePhotoTaken(data) {
            if (data.playerId === playerId) {
                gameState.playerStats.photosTaken++;
                showNotification('üì∏ Fotoƒüraf √ßekildi!', 'success');
            }
            
            // Create photo in game world
            createPhotoInWorld(data.position, data.photoId);
        }

        function handleGameEnded(data) {
            gameState.gameActive = false;
            
            // Update stats
            document.getElementById('statTime').textContent = formatTime(gameState.playerStats.timeSurvived);
            document.getElementById('statPhotos').textContent = gameState.playerStats.photosTaken;
            document.getElementById('statHunts').textContent = gameState.playerStats.hunts;
            document.getElementById('statXP').textContent = '+' + (gameState.playerStats.xp || 100);
            
            // Set result
            const isWinner = data.winner === playerId;
            document.getElementById('resultTitle').textContent = isWinner ? 'KAZANDIN!' : 'KAYBETTƒ∞N!';
            document.getElementById('resultIcon').className = `result-icon ${isWinner ? 'win' : 'lose'}`;
            document.getElementById('resultIcon').textContent = isWinner ? 'üèÜ' : 'üíÄ';
            
            showScreen('gameOverScreen');
            
            // Haptic feedback
            if (tg.isVersionAtLeast('6.1')) {
                tg.HapticFeedback.notificationOccurred(isWinner ? 'success' : 'error');
            }
        }

        // ==================== GAME UI ====================
        function updateGameUI() {
            // Update role
            const roleIcon = document.getElementById('roleIcon');
            const roleText = document.getElementById('roleText');
            
            if (gameState.isHunter) {
                roleIcon.className = 'role-icon hunter';
                roleIcon.textContent = 'üëπ';
                roleText.textContent = 'AVCI';
                document.getElementById('huntBtn').style.display = 'block';
            } else {
                roleIcon.className = 'role-icon runner';
                roleIcon.textContent = 'üèÉ';
                roleText.textContent = 'KA√áAN';
                document.getElementById('huntBtn').style.display = 'none';
            }
            
            // Show/hide game UI
            gameUI.style.display = 'block';
            
            // Update players HUD
            updatePlayersHUD();
        }

        function updatePlayersHUD() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            Object.values(gameState.players).forEach(p => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${p.isHunter ? 'hunter' : 'runner'}`;
                playerItem.innerHTML = `
                    <div>${p.isHunter ? 'üëπ' : 'üèÉ'} ${p.name}</div>
                    <div class="player-health">
                        <div class="health-bar" style="width: ${p.isAlive ? '100%' : '0%'}"></div>
                    </div>
                `;
                playersList.appendChild(playerItem);
            });
        }

        function startGameTimer() {
            updateTimer();
            
            const timerInterval = setInterval(() => {
                if (!gameState.gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                gameState.gameTime--;
                gameState.playerStats.timeSurvived++;
                
                if (gameState.gameTime <= 0) {
                    clearInterval(timerInterval);
                    // Game time ended
                }
                
                updateTimer();
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.gameTime / 60);
            const seconds = gameState.gameTime % 60;
            document.getElementById('gameTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==================== GAME ACTIONS ====================
        function huntAction() {
            if (!gameState.isHunter || !gameState.gameActive) return;
            
            // Check for nearby runners
            const nearbyRunners = [];
            
            Object.values(gameState.players).forEach(p => {
                if (!p.isHunter && p.isAlive) {
                    // Calculate distance (simplified)
                    const distance = Math.random() * 5; // In real game, calculate actual distance
                    if (distance < 2) {
                        nearbyRunners.push(p.id);
                    }
                }
            });
            
            if (nearbyRunners.length > 0) {
                // Capture the first nearby runner
                sendMessage({
                    type: 'capturePlayer',
                    playerId: playerId,
                    targetId: nearbyRunners[0]
                });
                
                // Haptic feedback
                if (tg.isVersionAtLeast('6.1')) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
        }

        function togglePhotoMode() {
            if (!gameState.gameActive) return;
            
            isPhotoMode = !isPhotoMode;
            const photoUI = document.getElementById('photoUI');
            photoUI.style.display = isPhotoMode ? 'block' : 'none';
            
            if (isPhotoMode) {
                showNotification('üì∏ Fotoƒüraf modu aktif', 'info');
            }
        }

        function capturePhoto() {
            if (!isPhotoMode) return;
            
            // Take photo at current position
            sendMessage({
                type: 'takePhoto',
                playerId: playerId,
                position: player ? player.position : { x: 0, y: 0, z: 0 }
            });
            
            togglePhotoMode();
        }

        function cancelPhoto() {
            togglePhotoMode();
        }

        function jumpAction() {
            // Simple jump action
            if (player && player.position) {
                player.position.y += 0.5;
                setTimeout(() => {
                    if (player) player.position.y -= 0.5;
                }, 300);
            }
        }

        // ==================== GAME OVER ACTIONS ====================
        function playAgain() {
            if (gameState.currentRoom) {
                sendMessage({
                    type: 'playAgain',
                    playerId: playerId,
                    roomCode: gameState.currentRoom
                });
                showScreen('lobbyScreen');
            } else {
                showScreen('mainMenu');
            }
        }

        function returnToLobby() {
            showScreen('lobbyScreen');
        }

        function returnToMenu() {
            if (gameState.gameActive) {
                sendMessage({
                    type: 'leaveGame',
                    playerId: playerId
                });
            }
            showScreen('mainMenu');
        }

        // ==================== THREE.JS GAME ENGINE ====================
        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x000000, 10, 150);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            gameContainer.appendChild(renderer.domElement);
            
            // Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffd700, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Resize handler
            window.addEventListener('resize', onWindowResize);
        }

        function createSimpleScene() {
            // Simple floor for loading
            const floorGeometry = new THREE.PlaneGeometry(100, 100);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
        }

        function start3DGame() {
            // Clear existing scene
            while(scene.children.length > 0) { 
                scene.remove(scene.children[0]); 
            }
            
            // Re-add lights
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffd700, 0.8);
            directionalLight.position.set(10, 20, 5);
            scene.add(directionalLight);
            
            // Create Backrooms maze
            createBackroomsMaze();
            
            // Create player
            createPlayer();
            
            // Create other players
            Object.keys(gameState.players).forEach(id => {
                if (id !== playerId) {
                    createOtherPlayer(id);
                }
            });
        }

        function createBackroomsMaze() {
            // Create large Backrooms maze
            const wallMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xf0e68c,
                emissive: 0x222222
            });
            
            const floorMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8b7355,
                emissive: 0x111111
            });
            
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(200, 200);
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Procedural maze generation
            const gridSize = 40;
            const cellSize = 5;
            
            maze = [];
            
            for (let x = 0; x < gridSize; x++) {
                for (let z = 0; z < gridSize; z++) {
                    // Create walls in a maze pattern
                    const isWall = (x === 0 || z === 0 || x === gridSize - 1 || z === gridSize - 1) ||
                                  (Math.random() > 0.7 && (x + z) % 3 === 0);
                    
                    if (isWall) {
                        const wallGeometry = new THREE.BoxGeometry(cellSize, 4, cellSize);
                        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall.position.set(
                            (x - gridSize / 2) * cellSize,
                            2,
                            (z - gridSize / 2) * cellSize
                        );
                        wall.castShadow = true;
                        wall.receiveShadow = true;
                        scene.add(wall);
                        maze.push(wall);
                    }
                }
            }
            
            // Create ceiling
            const ceilingGeometry = new THREE.PlaneGeometry(200, 200);
            const ceiling = new THREE.Mesh(ceilingGeometry, wallMaterial);
            ceiling.position.y = 4;
            ceiling.rotation.x = Math.PI / 2;
            scene.add(ceiling);
            
            // Add flickering lights
            for (let i = 0; i < 20; i++) {
                const light = new THREE.PointLight(0xffd700, 0.8, 20);
                light.position.set(
                    (Math.random() - 0.5) * 180,
                    3,
                    (Math.random() - 0.5) * 180
                );
                
                // Flicker effect
                (function(l) {
                    setInterval(() => {
                        l.intensity = 0.3 + Math.random() * 0.7;
                    }, 100 + Math.random() * 400);
                })(light);
                
                scene.add(light);
            }
        }

        function createPlayer() {
            const geometry = new THREE.CapsuleGeometry(0.3, 1.2, 8, 16);
            const material = new THREE.MeshLambertMaterial({ 
                color: gameState.isHunter ? 0xff4757 : 0x00ffaa,
                emissive: gameState.isHunter ? 0x330000 : 0x003300
            });
            
            player = new THREE.Mesh(geometry, material);
            player.castShadow = true;
            player.receiveShadow = true;
            
            // Random starting position
            player.position.set(
                (Math.random() - 0.5) * 50,
                1,
                (Math.random() - 0.5) * 50
            );
            
            scene.add(player);
            playerBox = new THREE.Box3().setFromObject(player);
            
            // Position camera at player
            camera.position.copy(player.position);
            camera.position.y = 1.7;
        }

        function createOtherPlayer(playerId) {
            const geometry = new THREE.CapsuleGeometry(0.3, 1.2, 8, 16);
            const material = new THREE.MeshLambertMaterial({ 
                color: 0x0099ff,
                emissive: 0x001133
            });
            
            const otherPlayer = new THREE.Mesh(geometry, material);
            otherPlayer.castShadow = true;
            otherPlayer.receiveShadow = true;
            otherPlayer.position.set(0, 1, 0);
            
            scene.add(otherPlayer);
            otherPlayers[playerId] = otherPlayer;
        }

        function createPhotoInWorld(position, photoId) {
            // Create a photo frame in the world
            const photoGeometry = new THREE.PlaneGeometry(1, 1);
            const photoMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                side: THREE.DoubleSide
            });
            
            const photo = new THREE.Mesh(photoGeometry, photoMaterial);
            photo.position.copy(position);
            photo.position.y = 1.5;
            photo.lookAt(camera.position);
            
            scene.add(photo);
            photos.push({ mesh: photo, id: photoId });
            
            // Remove after 30 seconds
            setTimeout(() => {
                scene.remove(photo);
                photo.geometry.dispose();
                photo.material.dispose();
                photos = photos.filter(p => p.id !== photoId);
            }, 30000);
        }

        // ==================== CONTROLS ====================
        function setupControls() {
            // Mobile joystick
            const joystickArea = document.getElementById('joystickArea');
            const joystickThumb = document.getElementById('joystickThumb');
            
            let joystickStart = { x: 0, y: 0 };
            const maxDistance = 50;
            
            joystickArea.addEventListener('touchstart', handleJoystickStart);
            joystickArea.addEventListener('touchmove', handleJoystickMove);
            joystickArea.addEventListener('touchend', handleJoystickEnd);
            
            function handleJoystickStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = joystickArea.getBoundingClientRect();
                
                joystickStart = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
                
                joystickActive = true;
            }
            
            function handleJoystickMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = joystickArea.getBoundingClientRect();
                
                let deltaX = touch.clientX - rect.left - joystickStart.x;
                let deltaY = touch.clientY - rect.top - joystickStart.y;
                
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                
                joystickVector.x = deltaX / maxDistance;
                joystickVector.y = -deltaY / maxDistance;
            }
            
            function handleJoystickEnd() {
                joystickActive = false;
                joystickThumb.style.transform = 'translate(-50%, -50%)';
                joystickVector.x = 0;
                joystickVector.y = 0;
            }
            
            // Mouse look
            let isLooking = false;
            let lastTouch = { x: 0, y: 0 };
            
            renderer.domElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && !joystickActive) {
                    const touch = e.touches[0];
                    const rect = renderer.domElement.getBoundingClientRect();
                    
                    // Only on right side of screen
                    if (touch.clientX - rect.left > window.innerWidth * 0.4) {
                        lastTouch.x = touch.clientX;
                        lastTouch.y = touch.clientY;
                        isLooking = true;
                    }
                }
            });
            
            renderer.domElement.addEventListener('touchmove', (e) => {
                if (!isLooking || e.touches.length !== 1) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouch.x;
                const deltaY = touch.clientY - lastTouch.y;
                
                mouseX += deltaX * 0.002;
                mouseY += deltaY * 0.002;
                mouseY = Math.max(-Math.PI/3, Math.min(Math.PI/3, mouseY));
                
                lastTouch.x = touch.clientX;
                lastTouch.y = touch.clientY;
            });
            
            renderer.domElement.addEventListener('touchend', () => {
                isLooking = false;
            });
            
            // Keyboard controls for testing
            document.addEventListener('keydown', (e) => {
                switch(e.code) {
                    case 'KeyW': joystickVector.y = 1; break;
                    case 'KeyS': joystickVector.y = -1; break;
                    case 'KeyA': joystickVector.x = -1; break;
                    case 'KeyD': joystickVector.x = 1; break;
                    case 'Space': jumpAction(); break;
                    case 'KeyF': togglePhotoMode(); break;
                }
            });
            
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'KeyW':
                    case 'KeyS': joystickVector.y = 0; break;
                    case 'KeyA':
                    case 'KeyD': joystickVector.x = 0; break;
                }
            });
        }

        // ==================== GAME LOOP ====================
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameState.gameActive && player) {
                // Player movement
                const speed = gameState.isHunter ? 0.15 : 0.12;
                const moveX = joystickVector.x * speed;
                const moveZ = joystickVector.y * speed;
                
                // Camera rotation
                camera.rotation.y -= mouseX * 0.05;
                camera.rotation.x = THREE.MathUtils.clamp(
                    camera.rotation.x - mouseY * 0.05, 
                    -Math.PI/3, 
                    Math.PI/3
                );
                
                // Movement based on camera direction
                const forward = new THREE.Vector3();
                camera.getWorldDirection(forward);
                forward.y = 0;
                forward.normalize();
                
                const right = new THREE.Vector3();
                right.crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
                
                const movement = new THREE.Vector3();
                movement.addScaledVector(forward, moveZ);
                movement.addScaledVector(right, moveX);
                
                // Collision detection
                const oldPosition = player.position.clone();
                player.position.add(movement);
                playerBox.setFromObject(player);
                
                let collision = false;
                for (const wall of maze) {
                    const wallBox = new THREE.Box3().setFromObject(wall);
                    if (playerBox.intersectsBox(wallBox)) {
                        collision = true;
                        break;
                    }
                }
                
                if (collision) {
                    player.position.copy(oldPosition);
                }
                
                // Update camera position
                camera.position.copy(player.position);
                camera.position.y = 1.7;
                
                // Head bobbing
                if (movement.length() > 0.01) {
                    const time = performance.now() * 0.001;
                    camera.position.y += Math.sin(time * 10) * 0.03;
                }
                
                // Smooth mouse movement
                mouseX *= 0.9;
                mouseY *= 0.9;
                
                // Send position to server
                sendMessage({
                    type: 'updatePosition',
                    playerId: playerId,
                    position: {
                        x: player.position.x,
                        y: player.position.y,
                        z: player.position.z
                    },
                    rotation: {
                        x: camera.rotation.x,
                        y: camera.rotation.y,
                        z: camera.rotation.z
                    }
                });
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
                gameState.screen = screenName;
                
                // Hide game UI if not in game
                gameUI.style.display = screenName === 'game' ? 'block' : 'none';
            }
        }

        function handleBackButton() {
            switch(gameState.screen) {
                case 'lobbyScreen':
                    leaveLobby();
                    break;
                case 'game':
                    if (confirm('Oyundan √ßƒ±kmak istiyor musunuz?')) {
                        returnToMenu();
                    }
                    break;
                default:
                    showScreen('mainMenu');
            }
        }

        function showNotification(text, type = 'info') {
            notification.textContent = text;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showHowToPlay() {
            const message = `
üéÆ **BACKROOMS HUNT - NASIL OYNANIR**

üëπ **AVCI (Hunter):**
- Diƒüer oyuncularƒ± yakalamaya √ßalƒ±≈ü
- Yakaladƒ±ƒüƒ±n her oyuncu i√ßin puan kazan
- Fotoƒüraf √ßekerek iz bƒ±rak

üèÉ **KA√áAN (Runner):**
- Avcƒ±dan ka√ßmaya √ßalƒ±≈ü
- Fotoƒüraf √ßekerek avcƒ±yƒ± ≈üa≈üƒ±rt
- En uzun s√ºre hayatta kal

üì∏ **FOTOƒûRAF MEKANƒ∞ƒûƒ∞:**
- Fotoƒüraf d√ºƒümesine bas
- Fotoƒüraf √ßekerek oyuna iz bƒ±rak
- Avcƒ± fotoƒüraflarƒ± takip edebilir

‚ö° **KONTROLLER:**
- Sol joystick: Hareket
- Saƒü ekran: Bakƒ±≈ü
- Fotoƒüraf d√ºƒümesi: Fotoƒüraf √ßek
- Av d√ºƒümesi: Avcƒ± i√ßin yakalama

            `;
            alert(message);
        }
    </script>
</body>
</html>
