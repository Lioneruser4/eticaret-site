<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Backrooms Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            height: 100vh;
            width: 100vw;
        }
        
        /* Ana Ekranlar */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            z-index: 1000;
            padding: 20px;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Ana Men√º */
        .main-menu {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(40, 40, 40, 0.95));
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .logo {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #ffd700, #ff6b00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 800;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }
        
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 40px;
            font-size: 1.2rem;
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            background: linear-gradient(45deg, #333, #555);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.3rem;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            letter-spacing: 1px;
            text-align: center;
        }
        
        .btn:hover {
            background: linear-gradient(45deg, #444, #666);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        
        .btn.primary {
            background: linear-gradient(45deg, #ff6b00, #ffd700);
            color: #000;
            border: none;
        }
        
        .btn.primary:hover {
            box-shadow: 0 5px 25px rgba(255, 107, 0, 0.6);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            color: white;
            border: none;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Oda Kurma */
        .room-create {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            border: 2px solid #00ff00;
        }
        
        .room-create h2 {
            color: #00ff00;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #444;
            background: #222;
            color: white;
            font-size: 1rem;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #00ff00;
        }
        
        /* Oda Listesi */
        .room-list {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            border: 2px solid #0099ff;
        }
        
        .room-list h2 {
            color: #0099ff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .room-item {
            background: rgba(50, 50, 50, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
            transition: all 0.3s;
        }
        
        .room-item:hover {
            background: rgba(70, 70, 70, 0.8);
            border-color: #0099ff;
            transform: translateX(5px);
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .room-stats {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .room-stats span {
            margin-right: 10px;
        }
        
        .join-btn {
            background: linear-gradient(45deg, #0099ff, #00ccff);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .join-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 153, 255, 0.5);
        }
        
        /* Lobi */
        .lobby {
            background: rgba(20, 20, 20, 0.98);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
        }
        
        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ffd700;
        }
        
        .room-code {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }
        
        .copy-code {
            background: #444;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .player-card.ready {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }
        
        .player-card.monster {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.05);
        }
        
        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #666, #888);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .player-card.monster .player-avatar {
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
        }
        
        .player-card.ready .player-avatar {
            background: linear-gradient(45deg, #00ff00, #66ff66);
        }
        
        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .player-status {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .lobby-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .ready-btn {
            background: linear-gradient(45deg, #00cc00, #00ff00);
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .ready-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.4);
        }
        
        .ready-btn.ready {
            background: linear-gradient(45deg, #ff6b00, #ffd700);
        }
        
        /* Oyun UI */
        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        canvas {
            display: block;
        }
        
        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .game-ui > * {
            pointer-events: auto;
        }
        
        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .hud-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .role-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .role-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .role-icon.human {
            background: linear-gradient(45deg, #00ff00, #66ff66);
        }
        
        .role-icon.monster {
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .players-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            min-width: 200px;
        }
        
        .player-hud-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .player-hud-item.monster {
            background: rgba(255, 0, 0, 0.2);
            border-left: 3px solid #ff0000;
        }
        
        .player-hud-item.human {
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #00ff00;
        }
        
        /* Mobil Kontroller */
        .mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            align-items: flex-end;
        }
        
        .joystick-area {
            width: 150px;
            height: 150px;
            position: relative;
            touch-action: none;
        }
        
        .joystick-bg {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 70%);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .joystick-thumb {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .action-btn.show {
            opacity: 1;
        }
        
        .action-btn:active {
            transform: scale(0.9);
        }
        
        .action-btn.escape {
            background: linear-gradient(45deg, #0099ff, #00ccff);
            box-shadow: 0 0 20px rgba(0, 153, 255, 0.5);
        }
        
        /* Bildirimler */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 25px 40px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.5rem;
            border: 3px solid #ffd700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            display: none;
            z-index: 1001;
            max-width: 90%;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            display: block;
            animation: popIn 0.3s ease-out;
        }
        
        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .notification.warning {
            border-color: #ff6b00;
            color: #ff6b00;
        }
        
        .notification.success {
            border-color: #00ff00;
            color: #00ff00;
        }
        
        .notification.error {
            border-color: #ff0000;
            color: #ff0000;
        }
        
        /* √áƒ±kƒ±≈ü Onayƒ± */
        .exit-confirm {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            backdrop-filter: blur(5px);
        }
        
        .exit-confirm.active {
            display: flex;
        }
        
        .exit-modal {
            background: linear-gradient(135deg, #222, #333);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #ff0000;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.3);
        }
        
        .exit-modal h3 {
            color: #ff0000;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .exit-modal p {
            margin-bottom: 25px;
            text-align: center;
            color: #ccc;
        }
        
        .exit-buttons {
            display: flex;
            gap: 15px;
        }
        
        .exit-buttons .btn {
            flex: 1;
        }
        
        /* Oyun Sonu Ekranƒ± */
        .game-over {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(40, 40, 40, 0.95));
            border: 3px solid #ffd700;
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .result-icon.win {
            color: #00ff00;
            text-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }
        
        .result-icon.lose {
            color: #ff0000;
            text-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }
        
        .game-over h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffd700, #ff6b00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffd700;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        /* Y√∂nlendirme Uyarƒ±sƒ± */
        .orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 2000;
            font-size: 1.5rem;
        }
        
        @media (orientation: portrait) {
            .orientation-warning {
                display: flex;
            }
        }
        
        .orientation-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }
            
            .btn {
                padding: 15px;
                font-size: 1.1rem;
            }
            
            .mobile-controls {
                padding: 0 20px;
            }
            
            .joystick-area {
                width: 120px;
                height: 120px;
            }
            
            .action-btn {
                width: 70px;
                height: 70px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.7);
        }
    </style>
</head>
<body>
    <!-- Y√∂nlendirme Uyarƒ±sƒ± -->
    <div class="orientation-warning">
        <div class="orientation-icon">üì±</div>
        <div>
            <h2>L√ºtfen Cihazƒ±nƒ±zƒ± √áevirin</h2>
            <p>Oyun en iyi yatay modda √ßalƒ±≈üƒ±r</p>
            <small>Telefonunuzu yan √ßevirerek devam edin</small>
        </div>
    </div>
    
    <!-- Ekranlar -->
    <div id="mainMenu" class="screen active">
        <div class="main-menu">
            <div class="logo">BACKROOMS ARENA</div>
            <div class="subtitle">3D Multiplayer Horror Chase Game</div>
            <div class="button-container">
                <button class="btn primary" onclick="showScreen('roomCreate')">ODA KUR</button>
                <button class="btn" onclick="showScreen('roomList')">ODALARA KATIL</button>
                <button class="btn" onclick="findQuickMatch()">HIZLI E≈ûLE≈ûME</button>
                <button class="btn" onclick="showScreen('howToPlay')">NASIL OYNANIR</button>
            </div>
        </div>
    </div>
    
    <!-- Oda Kurma -->
    <div id="roomCreate" class="screen">
        <div class="room-create">
            <h2>üìù ODA OLU≈ûTUR</h2>
            <div class="input-group">
                <label>Oda Adƒ±:</label>
                <input type="text" id="roomName" placeholder="Oda ƒ∞smi Girin" maxlength="20">
            </div>
            <div class="input-group">
                <label>Maksimum Oyuncu:</label>
                <select id="maxPlayers">
                    <option value="2">2 Oyuncu</option>
                    <option value="4">4 Oyuncu</option>
                    <option value="6">6 Oyuncu</option>
                    <option value="8">8 Oyuncu</option>
                    <option value="10" selected>10 Oyuncu</option>
                </select>
            </div>
            <div class="input-group">
                <label>Oyun S√ºresi (dakika):</label>
                <select id="gameTime">
                    <option value="3">3 Dakika</option>
                    <option value="5" selected>5 Dakika</option>
                    <option value="10">10 Dakika</option>
                </select>
            </div>
            <div class="button-container">
                <button class="btn primary" onclick="createRoom()">ODA OLU≈ûTUR</button>
                <button class="btn" onclick="showScreen('mainMenu')">GERƒ∞</button>
            </div>
        </div>
    </div>
    
    <!-- Oda Listesi -->
    <div id="roomList" class="screen">
        <div class="room-list">
            <h2>üéÆ AKTƒ∞F ODALAR</h2>
            <div id="roomsContainer">
                <div class="room-item">
                    <div class="room-info">
                        <div class="room-name">√ñrnek Oda</div>
                        <div class="room-stats">
                            <span>üë• 3/10</span>
                            <span>‚è±Ô∏è 5 dakika</span>
                        </div>
                    </div>
                    <button class="join-btn" onclick="joinRoom('test')">KATIL</button>
                </div>
            </div>
            <div class="button-container">
                <button class="btn" onclick="refreshRooms()">üîÑ Yenile</button>
                <button class="btn" onclick="showScreen('mainMenu')">GERƒ∞</button>
            </div>
        </div>
    </div>
    
    <!-- Lobi -->
    <div id="lobby" class="screen">
        <div class="lobby">
            <div class="lobby-header">
                <div>
                    <h2>üé™ LOBBY</h2>
                    <div class="room-code" id="lobbyCode">KOD: -----</div>
                </div>
                <button class="copy-btn" onclick="copyRoomCode()">üìã Kopyala</button>
            </div>
            
            <div class="players-grid" id="playersGrid">
                <!-- Oyuncu kartlarƒ± buraya gelecek -->
            </div>
            
            <div class="lobby-controls">
                <button class="ready-btn" id="readyButton" onclick="toggleReady()">HAZIR</button>
                <button class="btn danger" onclick="leaveLobby()">ODADAN √áIK</button>
            </div>
            
            <div class="lobby-info">
                <p>üéØ Oyun ba≈ülamak i√ßin t√ºm oyuncularƒ±n hazƒ±r olmasƒ± gerekiyor</p>
                <p>üëπ Rastgele bir oyuncu CANAVAR olarak ba≈ülayacak</p>
            </div>
        </div>
    </div>
    
    <!-- Oyun UI -->
    <div id="gameUI" class="game-ui" style="display: none;">
        <div class="game-hud">
            <div class="hud-panel">
                <div class="role-display">
                    <div class="role-icon human" id="roleIcon">üë§</div>
                    <span id="roleText">ƒ∞NSAN</span>
                </div>
                <div class="timer" id="gameTimer">05:00</div>
            </div>
            
            <div class="players-hud" id="playersHud">
                <!-- Oyuncu HUD √∂ƒüeleri -->
            </div>
        </div>
        
        <div class="mobile-controls">
            <div class="joystick-area" id="joystickArea">
                <div class="joystick-bg"></div>
                <div class="joystick-thumb" id="joystickThumb"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn monster-btn" id="attackBtn" onclick="playerAttack()">‚öîÔ∏è VUR</button>
                <button class="action-btn escape show" id="escapeBtn" onclick="escapeGame()">üèÉ KA√á</button>
            </div>
        </div>
    </div>
    
    <!-- Bildirimler -->
    <div class="notification" id="notification"></div>
    
    <!-- √áƒ±kƒ±≈ü Onayƒ± -->
    <div class="exit-confirm" id="exitConfirm">
        <div class="exit-modal">
            <h3>‚ö†Ô∏è OYUNDAN √áIK</h3>
            <p>Oyundan √ßƒ±kmak istediƒüinize emin misiniz? Puan kaybedebilirsiniz.</p>
            <div class="exit-buttons">
                <button class="btn danger" onclick="confirmExit()">EVET, √áIK</button>
                <button class="btn" onclick="cancelExit()">VAZGE√á</button>
            </div>
        </div>
    </div>
    
    <!-- Oyun Sonu -->
    <div id="gameOverScreen" class="screen">
        <div class="game-over">
            <div class="result-icon win" id="resultIcon">üèÜ</div>
            <h2 id="resultTitle">OYUN SONU</h2>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="statTime">00:00</div>
                    <div class="stat-label">S√úRE</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statKills">0</div>
                    <div class="stat-label">AV</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statEscapes">0</div>
                    <div class="stat-label">KA√áI≈û</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statXP">+100</div>
                    <div class="stat-label">XP</div>
                </div>
            </div>
            
            <div class="button-container">
                <button class="btn primary" onclick="returnToLobby()">LOBBY'E D√ñN</button>
                <button class="btn" onclick="returnToMenu()">ANA MEN√ú</button>
            </div>
        </div>
    </div>
    
    <!-- Oyun Konteyneri -->
    <div id="gameContainer"></div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Oyun State
        let gameState = {
            playerId: null,
            playerName: 'Player',
            currentScreen: 'mainMenu',
            currentRoom: null,
            isReady: false,
            isMonster: false,
            gameActive: false,
            gameTime: 300, // 5 dakika
            players: {},
            playerStats: {
                kills: 0,
                escapes: 0,
                timeSurvived: 0
            }
        };
        
        // WebSocket
        let ws = null;
        const SERVER_URL = 'wss://saskioyunu.onrender.com';
        
        // Three.js
        let scene, camera, renderer, controls;
        let playerMesh = null;
        let playerBox = null;
        let mazeWalls = [];
        let otherPlayers = {};
        
        // Kontroller
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let mouseX = 0, mouseY = 0;
        let moveSpeed = 0.1;
        
        // DOM Elementleri
        const screens = {
            mainMenu: document.getElementById('mainMenu'),
            roomCreate: document.getElementById('roomCreate'),
            roomList: document.getElementById('roomList'),
            lobby: document.getElementById('lobby'),
            gameOver: document.getElementById('gameOverScreen')
        };
        
        const notification = document.getElementById('notification');
        const exitConfirm = document.getElementById('exitConfirm');
        const gameUI = document.getElementById('gameUI');
        const gameContainer = document.getElementById('gameContainer');
        
        // Uygulama Ba≈ülatma
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupEventListeners();
            connectWebSocket();
        });
        
        function initApp() {
            // Telegram ayarlarƒ±
            tg.expand();
            tg.requestFullscreen();
            tg.enableClosingConfirmation();
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                handleBackButton();
            });
            
            // Rastgele oyuncu ID
            gameState.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            gameState.playerName = tg.initDataUnsafe?.user?.first_name || 'Player';
            
            // 3D Sahneyi hazƒ±rla (√∂n y√ºkleme)
            preload3DScene();
            
            console.log('App initialized with ID:', gameState.playerId);
        }
        
        function connectWebSocket() {
            ws = new WebSocket(SERVER_URL);
            
            ws.onopen = () => {
                console.log('Sunucuya baƒülandƒ±');
                sendMessage({ type: 'init', playerId: gameState.playerId, playerName: gameState.playerName });
                showNotification('Sunucuya baƒülandƒ±', 'success');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (error) {
                    console.error('Message parse error:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('Sunucu baƒülantƒ±sƒ± kesildi');
                showNotification('Sunucu baƒülantƒ±sƒ± kesildi. Yeniden baƒülanƒ±lƒ±yor...', 'error');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.warn('WebSocket not connected');
            }
        }
        
        function handleServerMessage(data) {
            switch(data.type) {
                case 'roomList':
                    updateRoomList(data.rooms);
                    break;
                    
                case 'roomCreated':
                    gameState.currentRoom = data.roomCode;
                    showScreen('lobby');
                    updateLobbyCode(data.roomCode);
                    break;
                    
                case 'roomJoined':
                    gameState.currentRoom = data.roomCode;
                    showScreen('lobby');
                    updateLobbyCode(data.roomCode);
                    updatePlayersList(data.players);
                    break;
                    
                case 'playerJoined':
                    updatePlayersList(data.players);
                    showNotification(`${data.playerName} odaya katƒ±ldƒ±`, 'warning');
                    break;
                    
                case 'playerLeft':
                    updatePlayersList(data.players);
                    showNotification(`${data.playerName} odadan ayrƒ±ldƒ±`, 'warning');
                    break;
                    
                case 'playerReady':
                    updatePlayersList(data.players);
                    if (data.playerId === gameState.playerId) {
                        gameState.isReady = data.isReady;
                        updateReadyButton();
                    }
                    break;
                    
                case 'gameStarting':
                    showNotification('Oyun ba≈ülƒ±yor!', 'success');
                    startGame(data.players, data.isMonster);
                    break;
                    
                case 'gameUpdate':
                    updateGameState(data.gameState);
                    break;
                    
                case 'roleChange':
                    handleRoleChange(data.newRole, data.targetId);
                    break;
                    
                case 'playerAttack':
                    handlePlayerAttack(data.attackerId, data.targetId);
                    break;
                    
                case 'gameEnded':
                    endGame(data.winner, data.stats);
                    break;
                    
                case 'error':
                    showNotification(data.message, 'error');
                    break;
            }
        }
        
        // Ekran Y√∂netimi
        function showScreen(screenName) {
            // T√ºm ekranlarƒ± gizle
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Hedef ekranƒ± g√∂ster
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
                gameState.currentScreen = screenName;
                
                // Telegram BackButton kontrol√º
                if (screenName === 'mainMenu') {
                    tg.BackButton.hide();
                } else {
                    tg.BackButton.show();
                }
            }
            
            // Oyun UI'yi kontrol et
            gameUI.style.display = screenName === 'game' ? 'block' : 'none';
        }
        
        function handleBackButton() {
            switch(gameState.currentScreen) {
                case 'roomCreate':
                case 'roomList':
                case 'howToPlay':
                    showScreen('mainMenu');
                    break;
                    
                case 'lobby':
                    leaveLobby();
                    break;
                    
                case 'game':
                    showExitConfirm();
                    break;
                    
                default:
                    showScreen('mainMenu');
            }
        }
        
        // Oda Y√∂netimi
        function createRoom() {
            const roomName = document.getElementById('roomName').value || 'My Room';
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const gameTime = parseInt(document.getElementById('gameTime').value);
            
            if (!roomName.trim()) {
                showNotification('L√ºtfen oda adƒ± girin', 'error');
                return;
            }
            
            sendMessage({
                type: 'createRoom',
                playerId: gameState.playerId,
                playerName: gameState.playerName,
                roomName: roomName,
                maxPlayers: maxPlayers,
                gameTime: gameTime
            });
        }
        
        function joinRoom(roomCode) {
            sendMessage({
                type: 'joinRoom',
                playerId: gameState.playerId,
                playerName: gameState.playerName,
                roomCode: roomCode
            });
        }
        
        function findQuickMatch() {
            sendMessage({
                type: 'quickMatch',
                playerId: gameState.playerId,
                playerName: gameState.playerName
            });
            showNotification('Hƒ±zlƒ± e≈üle≈üme aranƒ±yor...', 'warning');
        }
        
        function refreshRooms() {
            sendMessage({ type: 'getRooms' });
        }
        
        function updateRoomList(rooms) {
            const container = document.getElementById('roomsContainer');
            container.innerHTML = '';
            
            if (rooms.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Aktif oda bulunamadƒ±</div>';
                return;
            }
            
            rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                roomElement.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${room.name}</div>
                        <div class="room-stats">
                            <span>üë• ${room.players}/${room.maxPlayers}</span>
                            <span>‚è±Ô∏è ${room.gameTime} dakika</span>
                        </div>
                    </div>
                    <button class="join-btn" onclick="joinRoom('${room.code}')">KATIL</button>
                `;
                container.appendChild(roomElement);
            });
        }
        
        // Lobi Y√∂netimi
        function updateLobbyCode(code) {
            document.getElementById('lobbyCode').textContent = `KOD: ${code}`;
        }
        
        function updatePlayersList(players) {
            const container = document.getElementById('playersGrid');
            container.innerHTML = '';
            
            Object.values(players).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.isReady ? 'ready' : ''} ${player.isMonster ? 'monster' : ''}`;
                playerCard.innerHTML = `
                    <div class="player-avatar">
                        ${player.isMonster ? 'üëπ' : 'üë§'}
                    </div>
                    <div class="player-name">${player.name}</div>
                    <div class="player-status">${player.isReady ? 'HAZIR' : 'BEKLƒ∞YOR'}</div>
                    ${player.isHost ? '<div class="player-status">‚≠ê HOST</div>' : ''}
                `;
                container.appendChild(playerCard);
            });
            
            gameState.players = players;
        }
        
        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            sendMessage({
                type: 'setReady',
                playerId: gameState.playerId,
                isReady: gameState.isReady
            });
            updateReadyButton();
        }
        
        function updateReadyButton() {
            const btn = document.getElementById('readyButton');
            btn.textContent = gameState.isReady ? 'HAZIR DEƒûƒ∞L' : 'HAZIR';
            btn.classList.toggle('ready', gameState.isReady);
        }
        
        function leaveLobby() {
            sendMessage({
                type: 'leaveRoom',
                playerId: gameState.playerId
            });
            gameState.currentRoom = null;
            gameState.isReady = false;
            showScreen('mainMenu');
        }
        
        function copyRoomCode() {
            if (gameState.currentRoom) {
                navigator.clipboard.writeText(gameState.currentRoom);
                showNotification('Oda kodu kopyalandƒ±!', 'success');
            }
        }
        
        // Oyun Y√∂netimi
        function startGame(players, isMonster) {
            gameState.gameActive = true;
            gameState.isMonster = isMonster;
            gameState.players = players;
            
            showScreen('game');
            init3DGame();
            updateGameUI();
            startGameTimer();
            
            showNotification(isMonster ? 'üëπ CANAVAR olarak ba≈üladƒ±n!' : 'üë§ ƒ∞NSAN olarak ba≈üladƒ±n!', 'success');
            
            // Haptic feedback
            if (tg.isVersionAtLeast('6.1')) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
        }
        
        function updateGameUI() {
            document.getElementById('roleText').textContent = gameState.isMonster ? 'CANAVAR' : 'ƒ∞NSAN';
            document.getElementById('roleIcon').className = `role-icon ${gameState.isMonster ? 'monster' : 'human'}`;
            document.getElementById('roleIcon').textContent = gameState.isMonster ? 'üëπ' : 'üë§';
            
            // Saldƒ±rƒ± butonunu g√∂ster/gizle
            const attackBtn = document.getElementById('attackBtn');
            attackBtn.classList.toggle('show', gameState.isMonster);
            
            // Oyuncu HUD'u g√ºncelle
            updatePlayersHUD();
        }
        
        function updatePlayersHUD() {
            const container = document.getElementById('playersHud');
            container.innerHTML = '';
            
            Object.values(gameState.players).forEach(player => {
                const item = document.createElement('div');
                item.className = `player-hud-item ${player.isMonster ? 'monster' : 'human'}`;
                item.innerHTML = `
                    <span>${player.isMonster ? 'üëπ' : 'üë§'}</span>
                    <span>${player.name}</span>
                    ${player.isAlive ? '' : '<span style="color: #888;">‚ò†Ô∏è</span>'}
                `;
                container.appendChild(item);
            });
        }
        
        function startGameTimer() {
            gameState.gameTime = 300; // 5 dakika
            
            const timerElement = document.getElementById('gameTimer');
            
            const timer = setInterval(() => {
                if (!gameState.gameActive) {
                    clearInterval(timer);
                    return;
                }
                
                gameState.gameTime--;
                gameState.playerStats.timeSurvived++;
                
                const minutes = Math.floor(gameState.gameTime / 60);
                const seconds = gameState.gameTime % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (gameState.gameTime <= 0) {
                    clearInterval(timer);
                    // Oyun s√ºresi doldu
                }
            }, 1000);
        }
        
        function playerAttack() {
            if (!gameState.isMonster || !gameState.gameActive) return;
            
            sendMessage({
                type: 'attack',
                playerId: gameState.playerId
            });
            
            // Haptic feedback
            if (tg.isVersionAtLeast('6.1')) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        function handleRoleChange(newRole, targetId) {
            if (targetId === gameState.playerId) {
                gameState.isMonster = newRole === 'monster';
                updateGameUI();
                
                showNotification(newRole === 'monster' ? 'üëπ CANAVAR oldun!' : 'üë§ ƒ∞NSAN oldun!', 'warning');
                
                // Haptic feedback
                if (tg.isVersionAtLeast('6.1')) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
        }
        
        function handlePlayerAttack(attackerId, targetId) {
            if (targetId === gameState.playerId) {
                showNotification('üí• Vuruldun!', 'error');
                
                // Haptic feedback
                if (tg.isVersionAtLeast('6.1')) {
                    tg.HapticFeedback.impactOccurred('rigid');
                }
            }
        }
        
        function escapeGame() {
            showExitConfirm();
        }
        
        function showExitConfirm() {
            exitConfirm.classList.add('active');
        }
        
        function confirmExit() {
            exitConfirm.classList.remove('active');
            leaveGame();
        }
        
        function cancelExit() {
            exitConfirm.classList.remove('active');
        }
        
        function leaveGame() {
            sendMessage({
                type: 'leaveGame',
                playerId: gameState.playerId
            });
            
            gameState.gameActive = false;
            showScreen('mainMenu');
            
            if (renderer) {
                renderer.dispose();
                gameContainer.innerHTML = '';
            }
        }
        
        function endGame(winner, stats) {
            gameState.gameActive = false;
            
            // ƒ∞statistikleri g√ºncelle
            if (stats) {
                document.getElementById('statTime').textContent = formatTime(stats.timeSurvived);
                document.getElementById('statKills').textContent = stats.kills || 0;
                document.getElementById('statEscapes').textContent = stats.escapes || 0;
                document.getElementById('statXP').textContent = `+${stats.xp || 100}`;
            }
            
            // Kazanma/kaybetme durumunu g√∂ster
            const isWinner = winner === gameState.playerId;
            document.getElementById('resultTitle').textContent = isWinner ? 'KAZANDIN!' : 'KAYBETTƒ∞N!';
            document.getElementById('resultIcon').className = `result-icon ${isWinner ? 'win' : 'lose'}`;
            document.getElementById('resultIcon').textContent = isWinner ? 'üèÜ' : 'üíÄ';
            
            showScreen('gameOver');
            
            // Haptic feedback
            if (tg.isVersionAtLeast('6.1')) {
                tg.HapticFeedback.notificationOccurred(isWinner ? 'success' : 'error');
            }
        }
        
        function returnToLobby() {
            if (gameState.currentRoom) {
                showScreen('lobby');
            } else {
                showScreen('mainMenu');
            }
        }
        
        function returnToMenu() {
            showScreen('mainMenu');
        }
        
        // Yardƒ±mcƒ± Fonksiyonlar
        function showNotification(text, type = 'info') {
            notification.textContent = text;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 3D Oyun Motoru
        function preload3DScene() {
            // Three.js √∂n y√ºklemesi
            // Bu fonksiyon oyun ba≈ülamadan √∂nce 3D asset'leri y√ºkler
        }
        
        function init3DGame() {
            // Sahne
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x000000, 10, 100);
            
            // Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            gameContainer.appendChild(renderer.domElement);
            
            // I≈üƒ±klandƒ±rma
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            // Backrooms ƒ±≈üƒ±klarƒ±
            createBackroomsLights();
            
            // Labirent olu≈ütur
            createBackroomsMaze();
            
            // Oyuncu modeli
            createPlayerModel();
            
            // Kontroller
            setupControls();
            
            // Pencere boyutu deƒüi≈üikliƒüi
            window.addEventListener('resize', onWindowResize);
            
            // Oyun d√∂ng√ºs√ºn√º ba≈ülat
            animate();
        }
        
        function createBackroomsLights() {
            // Titreyen fluoresan ƒ±≈üƒ±klar
            for (let i = 0; i < 10; i++) {
                const light = new THREE.PointLight(0xffd700, 0.6, 15);
                light.position.set(
                    (Math.random() - 0.5) * 40,
                    3,
                    (Math.random() - 0.5) * 40
                );
                
                // Titreme efekti
                (function(l) {
                    setInterval(() => {
                        l.intensity = 0.3 + Math.random() * 0.5;
                    }, 100 + Math.random() * 500);
                })(light);
                
                scene.add(light);
            }
        }
        
        function createBackroomsMaze() {
            const wallMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xf5e6b3,
                emissive: 0x222222,
                side: THREE.DoubleSide
            });
            
            const floorMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8b7355,
                emissive: 0x111111
            });
            
            // Zemin
            const floorGeometry = new THREE.PlaneGeometry(50, 50);
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Backrooms duvarlarƒ± (prosed√ºrel labirent)
            const gridSize = 20;
            const cellSize = 2.5;
            
            // Basit labirent algoritmasƒ±
            const grid = [];
            for (let x = 0; x < gridSize; x++) {
                grid[x] = [];
                for (let z = 0; z < gridSize; z++) {
                    // Kenarlarda ve belli pattern'lerde duvar olu≈ütur
                    const isWall = (x === 0 || z === 0 || x === gridSize - 1 || z === gridSize - 1) || 
                                  (Math.random() > 0.7 && (x + z) % 3 === 0);
                    
                    if (isWall) {
                        const wallGeometry = new THREE.BoxGeometry(cellSize, 3, cellSize);
                        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall.position.set(
                            (x - gridSize / 2) * cellSize,
                            1.5,
                            (z - gridSize / 2) * cellSize
                        );
                        wall.castShadow = true;
                        wall.receiveShadow = true;
                        scene.add(wall);
                        mazeWalls.push(wall);
                    }
                }
            }
            
            // Tavan
            const ceilingGeometry = new THREE.PlaneGeometry(50, 50);
            const ceiling = new THREE.Mesh(ceilingGeometry, wallMaterial);
            ceiling.position.y = 3;
            ceiling.rotation.x = Math.PI / 2;
            scene.add(ceiling);
        }
        
        function createPlayerModel() {
            const geometry = new THREE.CapsuleGeometry(0.3, 1.2, 4, 8);
            const material = new THREE.MeshLambertMaterial({ 
                color: gameState.isMonster ? 0xff4444 : 0x44ff44,
                emissive: gameState.isMonster ? 0x330000 : 0x003300
            });
            
            playerMesh = new THREE.Mesh(geometry, material);
            playerMesh.castShadow = true;
            playerMesh.receiveShadow = true;
            scene.add(playerMesh);
            
            playerBox = new THREE.Box3().setFromObject(playerMesh);
        }
        
        function setupControls() {
            // Joystick kontrolleri
            const joystickArea = document.getElementById('joystickArea');
            const joystickThumb = document.getElementById('joystickThumb');
            
            let joystickStart = { x: 0, y: 0 };
            const maxDistance = 50;
            
            joystickArea.addEventListener('touchstart', handleJoystickStart);
            joystickArea.addEventListener('touchmove', handleJoystickMove);
            joystickArea.addEventListener('touchend', handleJoystickEnd);
            
            function handleJoystickStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = joystickArea.getBoundingClientRect();
                
                joystickStart = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
                
                joystickActive = true;
            }
            
            function handleJoystickMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = joystickArea.getBoundingClientRect();
                
                let deltaX = touch.clientX - rect.left - joystickStart.x;
                let deltaY = touch.clientY - rect.top - joystickStart.y;
                
                // Joystick sƒ±nƒ±rlarƒ±
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                // Joystick g√∂rselini g√ºncelle
                joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                
                // Hareket vekt√∂r√º
                joystickVector.x = deltaX / maxDistance;
                joystickVector.y = -deltaY / maxDistance;
            }
            
            function handleJoystickEnd() {
                joystickActive = false;
                joystickThumb.style.transform = 'translate(-50%, -50%)';
                joystickVector.x = 0;
                joystickVector.y = 0;
            }
            
            // Bakƒ±≈ü kontrol√º (saƒü tarafta kaydƒ±rma)
            let lastTouch = { x: 0, y: 0 };
            let isLooking = false;
            
            renderer.domElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const rect = renderer.domElement.getBoundingClientRect();
                    
                    // Saƒü tarafta mƒ±? (ekranƒ±n saƒü 60%)
                    if (touch.clientX - rect.left > window.innerWidth * 0.4) {
                        lastTouch.x = touch.clientX;
                        lastTouch.y = touch.clientY;
                        isLooking = true;
                    }
                }
            });
            
            renderer.domElement.addEventListener('touchmove', (e) => {
                if (!isLooking || e.touches.length !== 1) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouch.x;
                const deltaY = touch.clientY - lastTouch.y;
                
                mouseX += deltaX * 0.002;
                mouseY += deltaY * 0.002;
                
                lastTouch.x = touch.clientX;
                lastTouch.y = touch.clientY;
            });
            
            renderer.domElement.addEventListener('touchend', () => {
                isLooking = false;
            });
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameState.gameActive && playerMesh) {
                // Hareket
                const speed = gameState.isMonster ? 0.15 : 0.1;
                const moveX = joystickVector.x * speed;
                const moveZ = joystickVector.y * speed;
                
                // Kamera rotasyonu
                camera.rotation.y -= mouseX * 0.05;
                camera.rotation.x = THREE.MathUtils.clamp(camera.rotation.x - mouseY * 0.05, -Math.PI/3, Math.PI/3);
                
                // Hareket vekt√∂r√º (kamera y√∂n√ºne g√∂re)
                const forward = new THREE.Vector3();
                camera.getWorldDirection(forward);
                forward.y = 0;
                forward.normalize();
                
                const right = new THREE.Vector3();
                right.crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
                
                const movement = new THREE.Vector3();
                movement.addScaledVector(forward, moveZ);
                movement.addScaledVector(right, moveX);
                
                // Collision kontrol√º
                const oldPosition = playerMesh.position.clone();
                playerMesh.position.add(movement);
                playerBox.setFromObject(playerMesh);
                
                let collision = false;
                for (const wall of mazeWalls) {
                    const wallBox = new THREE.Box3().setFromObject(wall);
                    if (playerBox.intersectsBox(wallBox)) {
                        collision = true;
                        break;
                    }
                }
                
                if (collision) {
                    playerMesh.position.copy(oldPosition);
                }
                
                // Kamerayƒ± oyuncuya baƒüla
                camera.position.copy(playerMesh.position);
                camera.position.y = 1.7;
                
                // Head bobbing efekti
                if (movement.length() > 0.01) {
                    const time = performance.now() * 0.001;
                    camera.position.y += Math.sin(time * 10) * 0.03;
                }
                
                // Mouse hareketini yumu≈üat
                mouseX *= 0.9;
                mouseY *= 0.9;
                
                // Pozisyonu sunucuya g√∂nder
                sendMessage({
                    type: 'updatePosition',
                    playerId: gameState.playerId,
                    position: {
                        x: playerMesh.position.x,
                        y: playerMesh.position.y,
                        z: playerMesh.position.z
                    },
                    rotation: {
                        x: camera.rotation.x,
                        y: camera.rotation.y,
                        z: camera.rotation.z
                    }
                });
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        function setupEventListeners() {
            // Klavye kontrolleri (debug i√ßin)
            document.addEventListener('keydown', (e) => {
                switch(e.code) {
                    case 'KeyW': joystickVector.y = 1; break;
                    case 'KeyS': joystickVector.y = -1; break;
                    case 'KeyA': joystickVector.x = -1; break;
                    case 'KeyD': joystickVector.x = 1; break;
                    case 'Space': playerAttack(); break;
                }
            });
            
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'KeyW':
                    case 'KeyS': joystickVector.y = 0; break;
                    case 'KeyA':
                    case 'KeyD': joystickVector.x = 0; break;
                }
            });
            
            // Gyroscope desteƒüi
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS i√ßin izin iste
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            } else if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
            
            function handleOrientation(e) {
                if (e.gamma && e.beta && gameState.gameActive) {
                    mouseX = e.gamma * 0.01;
                    mouseY = (e.beta - 90) * 0.01;
                }
            }
            
            // Tam ekran i√ßin √ßift tƒ±klama
            renderer?.domElement?.addEventListener('dblclick', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            });
        }
        
        // Sayfa g√∂r√ºn√ºrl√ºƒü√º
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && gameState.gameActive) {
                showNotification('Oyun duraklatƒ±ldƒ±', 'warning');
            }
        });
    </script>
</body>
</html>
