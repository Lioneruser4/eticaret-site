<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barkod & QR Oxuyucu</title>
  <script src="https://unpkg.com/@zxing/library@0.20.0/dist/index.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
    video { width: 100%; max-width: 500px; border: 4px solid #333; border-radius: 12px; }
    #result { margin-top: 20px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn { padding: 12px 24px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #0056b3; }
    .original { color: green; font-weight: bold; }
    .fake { color: red; font-weight: bold; }
    .expiry { font-size: 18px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ğŸ“± Barkod / QR / IBAN Oxuyucu</h1>
  <p>KameranÄ± mÉ™hsulun barkoduna tut</p>
  
  <video id="video" playsinline></video>
  <div id="result">OxumaÄŸa hazÄ±r...</div>
  
  <button class="btn" onclick="startScanner()">â–¶ YenidÉ™n BaÅŸlat</button>

  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoElement = document.getElementById('video');
    const resultElement = document.getElementById('result');
    let scanning = false;

    function startScanner() {
      resultElement.innerHTML = "Kamera aÃ§Ä±lÄ±r...";
      codeReader.decodeFromVideoDevice(null, videoElement, async (result, err) => {
        if (result && !scanning) {
          scanning = true;
          const text = result.getText().trim();
          await processCode(text);
          setTimeout(() => scanning = false, 3000);
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
        }
      });
    }

    async function processCode(code) {
      resultElement.innerHTML = `<strong>TAPILDI:</strong> ${code}<br><br>YoxlanÄ±lÄ±r...`;

      // IBAN yoxlamasÄ±
      if (/^[A-Z]{2}\d{2}[A-Z0-9]{11,30}$/.test(code.replace(/\s/g,''))) {
        resultElement.innerHTML += `<br>âœ… Bu IBAN-dÄ±r!<br><b>${code}</b>`;
        speak(`IBAN tapÄ±ldÄ±: ${code.substring(0,20)}...`);
        return;
      }

      // QR kod (linkdirsÉ™)
      if (code.startsWith('http')) {
        resultElement.innerHTML += `<br>ğŸ”— QR Link: <a href="${code}" target="_blank">${code}</a>`;
        speak("QR kod linki tapÄ±ldÄ±");
        return;
      }

      // Barkod - mÉ™hsul mÉ™lumatÄ±
      if (/^\d{8,14}$/.test(code)) {
        await checkProduct(code);
      } else {
        resultElement.innerHTML += `<br>â„¹ï¸ DigÉ™r kod: ${code}`;
      }
    }

    async function checkProduct(barcode) {
      let info = `<br><b>Barkod:</b> ${barcode}<br>`;

      // 1. Open Food Facts (yemÉ™k mÉ™hsullarÄ±)
      const food = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
        .then(r => r.json()).catch(() => null);
      if (food && food.status === 1) {
        const p = food.product;
        info += `<br>ğŸ” <b>${p.product_name || "AdsÄ±z mÉ™hsul"}</b><br>`;
        if (p.brands) info += `Marka: ${p.brands}<br>`;
        speak(`MÉ™hsul tapÄ±ldÄ±: ${p.product_name || p.brands}`);
        resultElement.innerHTML = info;
        return;
      }

      // 2. Kosmetika & ParfÃ¼m orijinallÄ±q yoxlamasÄ±
      const cosmetic = await fetch(`https://api.checkcosmetic.com/api/v1/products/${barcode}`).then(r=>r.json()).catch(()=>null)
        || await fetch(`https://makeup-api.herokuapp.com/api/v1/products.json?barcode=${barcode}`).then(r=>r.json()).catch(()=>null);
      
      if (cosmetic && (cosmetic.production_date || cosmetic[0])) {
        const c = Array.isArray(cosmetic) ? cosmetic[0] : cosmetic;
        const expiry = calculateExpiry(c);
        info += `<br>ğŸ’„ <b>${c.name || c.brand || "Kosmetika"}</b><br>`;
        if (expiry) {
          const monthsLeft = monthsBetween(new Date(), new Date(expiry));
          info += `<div class="expiry">ğŸ“… Son istifadÉ™: ${expiry}</div>`;
          info += monthsLeft > 0 
            ? `<span class="original">âœ… Orijinal â€¢ ${monthsLeft} ay qalÄ±b</span>`
            : `<span class="fake">âš ï¸ MÃ¼ddÉ™ti bitib!</span>`;
        } else {
          info += `<span class="original">âœ… Orijinal gÃ¶rÃ¼nÃ¼r</span>`;
        }
        speak("ParfÃ¼m orijinaldÄ±r");
      } else {
        // 3. Ãœmumi UPC axtarÄ±ÅŸÄ±
        const upc = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`).then(r=>r.json()).catch(()=>null);
        if (upc && upc.items && upc.items[0]) {
          info += `<br>ğŸ“¦ <b>${upc.items[0].title}</b><br>Marka: ${upc.items[0].brand || "Bilinmir"}`;
        } else {
          info += `<br>â„¹ï¸ Bu barkod bazada tapÄ±lmadÄ±, amma oxundu`;
        }
      }

      resultElement.innerHTML = info;
    }

    function calculateExpiry(data) {
      if (data.expiration_date) return data.expiration_date.split("T")[0];
      if (data.production_date) {
        const prod = new Date(data.production_date);
        const months = data.shelf_life_months || 36; // default 3 il
        return new Date(prod.setMonth(prod.getMonth() + months)).toISOString().split("T")[0];
      }
      return null;
    }

    function monthsBetween(d1, d2) {
      return (d2.getFullYear() - d1.getFullYear()) * 12 + d2.getMonth() - d1.getMonth();
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "az-AZ";
        speechSynthesis.speak(utter);
      }
    }

    // Avtomatik baÅŸla
    startScanner();
  </script>
</body>
</html>
