<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim NFC Sohbet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00b4db, #0083b0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 1.1rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-card {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .button {
            background: linear-gradient(90deg, #00b4db, #0083b0);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .icon {
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-details h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 70vh;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.sent {
            background: linear-gradient(135deg, #667eea, #764ba2);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .chat-input button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
        }

        .nfc-scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .nfc-scan-overlay.active {
            display: flex;
        }

        .nfc-animation {
            width: 200px;
            height: 200px;
            border: 3px dashed #00b4db;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .nfc-animation::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #00b4db, transparent);
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(400%); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .compatibility-warning {
            background: rgba(255, 87, 87, 0.1);
            border: 1px solid rgba(255, 87, 87, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .compatibility-warning.show {
            display: block;
        }

        .compatibility-warning p {
            color: #ff5757;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí Anonim NFC Sohbet</h1>
            <p class="subtitle">NFC kartƒ±nƒ±zla anƒ±nda g√ºvenli sohbet</p>
        </header>

        <div class="compatibility-warning" id="compatibilityWarning">
            <p>‚ö†Ô∏è Tarayƒ±cƒ±nƒ±z NFC'yi desteklemiyor. Sohbete eri≈ümek i√ßin alternatif y√∂ntem:</p>
        </div>

        <div class="card status-card">
            <div class="status-indicator"></div>
            <div>
                <h3>Sistem Durumu</h3>
                <p id="systemStatus">Ba≈ülatƒ±lƒ±yor...</p>
            </div>
        </div>

        <div id="authSection">
            <div class="card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h3 id="userName">Anonim Kullanƒ±cƒ±</h3>
                        <p id="userId">ID: Y√ºkleniyor...</p>
                    </div>
                </div>

                <button class="button" onclick="startNFCAuth()" id="nfcButton">
                    <span class="icon">üì±</span>
                    NFC Kartƒ±nƒ± Okut
                </button>

                <button class="button secondary" onclick="manualAuth()" id="manualButton">
                    <span class="icon">üîë</span>
                    Manuel Giri≈ü (Yedek)
                </button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="user-info">
                    <div class="avatar" id="chatUserAvatar">A</div>
                    <div>
                        <h3 id="chatUserName">Anonim</h3>
                        <p id="chatStatus">√áevrimi√ßi</p>
                    </div>
                </div>
                <button class="button secondary" onclick="showUserSearch()">
                    <span class="icon">üîç</span>
                    Kullanƒ±cƒ± Ara
                </button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Mesajlar buraya gelecek -->
            </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">
                    <span class="icon">‚û§</span>
                </button>
            </div>
        </div>

        <div class="nfc-scan-overlay" id="nfcScanOverlay">
            <div class="nfc-animation">
                <span style="font-size: 3rem; color: #00b4db;">üì±</span>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Global deƒüi≈ükenler
        let userId = null;
        let userName = null;
        let userAvatar = 'A';
        let socket = null;
        let currentChat = null;
        let nfcSupported = false;
        let isTelegramWebView = false;

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Sayfa y√ºklendi');
            
            // Telegram WebView kontrol√º
            detectEnvironment();
            
            // NFC desteƒüini kontrol et
            await checkNFCSupport();
            
            // Kullanƒ±cƒ± ID'sini al
            await initializeUser();
            
            // WebSocket baƒülantƒ±sƒ±nƒ± kur
            connectWebSocket();
            
            // NFC butonunu yapƒ±landƒ±r
            setupNFCButton();
        });

        // Ortamƒ± tespit et
        function detectEnvironment() {
            const userAgent = navigator.userAgent.toLowerCase();
            isTelegramWebView = userAgent.includes('telegram') || 
                               userAgent.includes('webview') ||
                               window.TelegramWebViewProxy !== undefined;
            
            console.log('Telegram WebView:', isTelegramWebView);
            console.log('User Agent:', userAgent);
            
            if (isTelegramWebView) {
                document.getElementById('systemStatus').textContent = 'Telegram WebView algƒ±landƒ±';
                showToast('Telegram WebView modunda');
            }
        }

        // NFC desteƒüini kontrol et
        async function checkNFCSupport() {
            try {
                // Web NFC API kontrol√º
                if ('NDEFReader' in window) {
                    nfcSupported = true;
                    document.getElementById('systemStatus').textContent = 'NFC destekleniyor';
                    console.log('NFC API destekleniyor');
                } else {
                    nfcSupported = false;
                    document.getElementById('systemStatus').textContent = 'NFC desteklenmiyor';
                    document.getElementById('compatibilityWarning').classList.add('show');
                    console.log('NFC API desteklenmiyor');
                }
            } catch (error) {
                console.error('NFC kontrol hatasƒ±:', error);
                nfcSupported = false;
            }
        }

        // NFC butonunu yapƒ±landƒ±r
        function setupNFCButton() {
            const nfcButton = document.getElementById('nfcButton');
            
            if (!nfcSupported) {
                nfcButton.innerHTML = '<span class="icon">‚ö†Ô∏è</span> NFC Desteklenmiyor';
                nfcButton.disabled = true;
                nfcButton.style.opacity = '0.5';
                nfcButton.style.cursor = 'not-allowed';
                
                // Manuel giri≈ü butonunu vurgula
                document.getElementById('manualButton').style.background = 'linear-gradient(90deg, #4CAF50, #2E7D32)';
            }
        }

        // Kullanƒ±cƒ±yƒ± ba≈ülat (Telegram'dan veya olu≈ütur)
        async function initializeUser() {
            try {
                // URL'den Telegram verilerini al
                const urlParams = new URLSearchParams(window.location.search);
                const tgInitData = urlParams.get('tgInitData');
                
                if (tgInitData) {
                    // Telegram'dan gelen verileri parse et
                    await handleTelegramData(tgInitData);
                } else {
                    // Rastgele kullanƒ±cƒ± olu≈ütur
                    await createRandomUser();
                }
                
                updateUserDisplay();
            } catch (error) {
                console.error('Kullanƒ±cƒ± ba≈ülatma hatasƒ±:', error);
                await createRandomUser();
                updateUserDisplay();
            }
        }

        // Telegram verilerini i≈üle
        async function handleTelegramData(initData) {
            try {
                // initData'yi parse et (√∂rnek format)
                const params = new URLSearchParams(initData);
                const tgUser = params.get('user');
                
                if (tgUser) {
                    const userData = JSON.parse(decodeURIComponent(tgUser));
                    userId = `tg_${userData.id}`;
                    userName = userData.first_name || `Kullanƒ±cƒ±_${userData.id}`;
                    userAvatar = userName.charAt(0).toUpperCase();
                    
                    // Kullanƒ±cƒ± adƒ± varsa ekle
                    if (userData.username) {
                        userName = `@${userData.username}`;
                    }
                } else {
                    await createRandomUser();
                }
            } catch (error) {
                console.error('Telegram veri i≈üleme hatasƒ±:', error);
                await createRandomUser();
            }
        }

        // Rastgele kullanƒ±cƒ± olu≈ütur
        async function createRandomUser() {
            const randomId = Math.random().toString(36).substring(2, 10);
            userId = `anon_${randomId}`;
            userName = `Anonim_${randomId.substring(0, 4)}`;
            userAvatar = userName.charAt(0).toUpperCase();
        }

        // Kullanƒ±cƒ± bilgilerini g√ºncelle
        function updateUserDisplay() {
            document.getElementById('userName').textContent = userName;
            document.getElementById('userId').textContent = `ID: ${userId}`;
            document.getElementById('userAvatar').textContent = userAvatar;
            document.getElementById('chatUserAvatar').textContent = userAvatar;
            document.getElementById('chatUserName').textContent = userName;
        }

        // WebSocket baƒülantƒ±sƒ±
        function connectWebSocket() {
            // Render.com WebSocket URL'si
            const wsUrl = 'wss://' + window.location.hostname;
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocket baƒülantƒ±sƒ± kuruldu');
                document.getElementById('systemStatus').textContent = 'Sunucuya baƒülandƒ±';
                
                // Kullanƒ±cƒ±yƒ± kaydet
                registerUser();
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleSocketMessage(data);
                } catch (error) {
                    console.error('Mesaj i≈üleme hatasƒ±:', error);
                }
            };
            
            socket.onclose = function() {
                console.log('WebSocket baƒülantƒ±sƒ± kapandƒ±');
                document.getElementById('systemStatus').textContent = 'Baƒülantƒ± kesildi';
                
                // 5 saniye sonra yeniden baƒülan
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket hatasƒ±:', error);
            };
        }

        // Kullanƒ±cƒ±yƒ± sunucuya kaydet
        function registerUser() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'register',
                    userId: userId,
                    userName: userName,
                    telegramData: window.location.search,
                    timestamp: Date.now()
                };
                socket.send(JSON.stringify(message));
            }
        }

        // NFC ile kimlik doƒürulama ba≈ülat
        async function startNFCAuth() {
            if (!nfcSupported) {
                showToast('Tarayƒ±cƒ±nƒ±z NFC\'yi desteklemiyor');
                return;
            }
            
            showNFCOverlay();
            
            try {
                if (isTelegramWebView) {
                    // Telegram WebView i√ßin √∂zel yakla≈üƒ±m
                    await handleTelegramNFC();
                } else {
                    // Normal tarayƒ±cƒ± i√ßin Web NFC API
                    await handleWebNFC();
                }
            } catch (error) {
                console.error('NFC okuma hatasƒ±:', error);
                showToast('NFC okuma ba≈üarƒ±sƒ±z: ' + error.message);
                hideNFCOverlay();
            }
        }

        // Telegram WebView i√ßin NFC i≈üleme
        async function handleTelegramNFC() {
            showToast('Telegram WebView NFC test ediliyor...');
            
            // Telegram Bot API √ºzerinden NFC verisi al
            // Bu kƒ±sƒ±m Telegram Bot entegrasyonu gerektirir
            await simulateNFCAuth();
        }

        // Web NFC API ile okuma
        async function handleWebNFC() {
            try {
                const ndef = new NDEFReader();
                
                await ndef.scan();
                
                ndef.onreading = async (event) => {
                    console.log('NFC kartƒ± okundu:', event);
                    
                    const nfcId = event.serialNumber;
                    const nfcData = {};
                    
                    for (const record of event.message.records) {
                        nfcData[record.recordType] = await record.data.text();
                    }
                    
                    // NFC verisini sunucuya g√∂nder
                    sendNFCAuth(nfcId, nfcData);
                    
                    // Sohbet ekranƒ±nƒ± g√∂ster
                    showChat();
                };
                
                ndef.onreadingerror = (error) => {
                    console.error('NFC okuma hatasƒ±:', error);
                    showToast('NFC okuma hatasƒ±: ' + error.message);
                    hideNFCOverlay();
                };
                
                // 30 saniye sonra zaman a≈üƒ±mƒ±
                setTimeout(() => {
                    hideNFCOverlay();
                    showToast('NFC okuma zaman a≈üƒ±mƒ±');
                }, 30000);
                
            } catch (error) {
                throw error;
            }
        }

        // NFC kimlik doƒürulamasƒ±nƒ± sim√ºle et
        async function simulateNFCAuth() {
            // Demo i√ßin rastgele NFC ID olu≈ütur
            const simulatedNFCId = 'nfc_' + Math.random().toString(36).substring(2, 15);
            const nfcData = {
                type: 'simulated',
                timestamp: Date.now()
            };
            
            setTimeout(() => {
                sendNFCAuth(simulatedNFCId, nfcData);
                showChat();
            }, 2000);
        }

        // NFC kimlik doƒürulamasƒ±nƒ± sunucuya g√∂nder
        function sendNFCAuth(nfcId, nfcData) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'nfc_auth',
                    userId: userId,
                    nfcId: nfcId,
                    nfcData: nfcData,
                    timestamp: Date.now()
                };
                socket.send(JSON.stringify(message));
                showToast('NFC doƒürulandƒ±');
            }
        }

        // Manuel giri≈ü (yedek y√∂ntem)
        function manualAuth() {
            const pin = prompt('G√ºvenlik PIN\'i girin (demo: 1234):');
            
            if (pin === '1234') {
                showToast('Manuel giri≈ü ba≈üarƒ±lƒ±');
                showChat();
            } else {
                showToast('Ge√ßersiz PIN');
            }
        }

        // Sohbet ekranƒ±nƒ± g√∂ster
        function showChat() {
            hideNFCOverlay();
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            
            // Kar≈üƒ±lama mesajƒ±
            addMessage('Sistem', 'Anonim sohbete ho≈ü geldiniz! Mesajlar anlƒ±ktƒ±r ve kaydedilmez.', 'received');
        }

        // NFC overlay g√∂ster/gizle
        function showNFCOverlay() {
            document.getElementById('nfcScanOverlay').classList.add('active');
        }

        function hideNFCOverlay() {
            document.getElementById('nfcScanOverlay').classList.remove('active');
        }

        // Mesaj g√∂nder
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChat) {
                showToast('√ñnce bir sohbet ba≈ülatƒ±n');
                return;
            }
            
            // Mesajƒ± ekrana ekle
            addMessage('Siz', message, 'sent');
            
            // WebSocket ile g√∂nder
            if (socket && socket.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'message',
                    userId: userId,
                    chatId: currentChat,
                    content: message,
                    timestamp: Date.now()
                };
                socket.send(JSON.stringify(data));
            }
            
            // Input'u temizle
            input.value = '';
            input.focus();
        }

        // Mesaj ekle
        function addMessage(sender, text, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = `${sender}: ${text}`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // WebSocket mesajlarƒ±nƒ± i≈üle
        function handleSocketMessage(data) {
            switch (data.type) {
                case 'registered':
                    console.log('Sunucuya kaydedildi:', data);
                    break;
                    
                case 'nfc_auth_success':
                    showToast('NFC doƒürulama ba≈üarƒ±lƒ±');
                    showChat();
                    break;
                    
                case 'message':
                    if (data.chatId === currentChat && data.senderId !== userId) {
                        addMessage(data.senderName || 'Anonim', data.content, 'received');
                    }
                    break;
                    
                case 'chat_started':
                    currentChat = data.chatId;
                    showToast(`${data.otherUserName} ile sohbet ba≈ülatƒ±ldƒ±`);
                    break;
                    
                case 'error':
                    showToast('Hata: ' + data.message);
                    break;
            }
        }

        // Kullanƒ±cƒ± arama
        function showUserSearch() {
            const userId = prompt('Aramak istediƒüiniz kullanƒ±cƒ± ID\'sini girin:');
            if (userId) {
                searchUser(userId);
            }
        }

        function searchUser(searchId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'search_user',
                    userId: userId,
                    searchId: searchId,
                    timestamp: Date.now()
                };
                socket.send(JSON.stringify(data));
            }
        }

        // Enter tu≈üu ile mesaj g√∂nder
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Toast mesajƒ± g√∂ster
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Ekran yakalama korumasƒ±
        document.addEventListener('keydown', function(e) {
            // Print Screen, F12 vb. engelle
            if (e.key === 'PrintScreen' || e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))) {
                e.preventDefault();
                showToast('Bu i≈ülem g√ºvenlik nedeniyle engellendi');
                return false;
            }
        });

        // Sayfadan √ßƒ±karken uyarƒ±
        window.addEventListener('beforeunload', function(e) {
            // Mesajlarƒ± temizle
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>
</html>
