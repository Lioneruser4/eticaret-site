<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Backrooms: The Chase</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a10; touch-action: none; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; 
                   background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.4) 80%); z-index: 10; }
        #vhs-effect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.05; pointer-events: none; background: url('https://media.giphy.com/media/oEI9uWUic89VK/giphy.gif'); z-index: 20; }
        #ui { position: fixed; bottom: 20px; left: 20px; color: #ffff00; font-family: 'Courier New', monospace; z-index: 30; text-shadow: 2px 2px #000; }
        .joystick { position: fixed; bottom: 40px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,0,0.2); border: 2px solid #ffff00; border-radius: 50%; z-index: 100; display: flex; align-items: center; justify-content: center; color: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="vhs-effect"></div>
    <div id="ui">LEVEL 0 - DURUM: HAYATTA</div>
    <div class="joystick" id="moveBtn">YÜRÜ</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // --- 3D SAHNE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222200);
        scene.fog = new THREE.Fog(0x222200, 1, 15); // Sis efekti (Görüş kısıtlı)

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- DUVARLAR VE ZEMİN (Sarı halı ve duvar kağıdı) ---
        const wallMat = new THREE.MeshPhongMaterial({ color: 0xcccc77 });
        const floorMat = new THREE.MeshPhongMaterial({ color: 0x888844 });

        // Labirent oluşturma (Basit bir 10x10 alan)
        for(let i = -5; i < 5; i++) {
            for(let j = -5; j < 5; j++) {
                if(Math.random() > 0.7) {
                    const wall = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), wallMat);
                    wall.position.set(i*4, 2, j*4);
                    scene.add(wall);
                }
            }
        }

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Cılız Işık (Backrooms Lambası)
        const light = new THREE.PointLight(0xffffaa, 1, 20);
        camera.add(light); // Işık kamerayla hareket eder (El feneri gibi)
        scene.add(camera);

        // --- ONLINE BAĞLANTI ---
        // BURASI ÖNEMLİ: Kendi Render linkini tırnak içine yaz!
        const socket = new WebSocket("wss://saskioyunu.onrender.com");
        let otherPlayers = {};

        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'sync') {
                Object.keys(data.players).forEach(id => {
                    if(id === socket.id) return;
                    if(!otherPlayers[id]) {
                        // Yeni oyuncu (Canavar veya İnsan)
                        const geometry = new THREE.BoxGeometry(1, 2, 1);
                        const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                        otherPlayers[id] = new THREE.Mesh(geometry, material);
                        scene.add(otherPlayers[id]);
                    }
                    otherPlayers[id].position.set(data.players[id].x, 1, data.players[id].z);
                });
            }
        };

        // --- HAREKET ---
        let walking = false;
        document.getElementById('moveBtn').ontouchstart = () => walking = true;
        document.getElementById('moveBtn').ontouchend = () => walking = false;

        let lastX = 0;
        document.addEventListener('touchmove', (e) => {
            let dx = e.touches[0].clientX - lastX;
            if(lastX !== 0) camera.rotation.y -= dx * 0.01;
            lastX = e.touches[0].clientX;
        });

        function animate() {
            requestAnimationFrame(animate);
            if(walking) camera.translateZ(-0.1);
            
            // Kafa sallanma efekti (Yürürken)
            if(walking) camera.position.y = 1.6 + Math.sin(Date.now() * 0.01) * 0.05;

            // Pozisyonu sunucuya bildir
            if(socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    x: camera.position.x,
                    z: camera.position.z,
                    ry: camera.rotation.y
                }));
            }
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
