<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Backrooms Pro FPS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; touch-action: none; }
        
        /* LOBİ EKRANI */
        #lobby {
            position: fixed; inset: 0; background: #1a1a00;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; color: yellow; font-family: sans-serif;
        }

        /* OYUN İÇİ BUTONLAR */
        #ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
        
        /* Sol Joystick Alanı */
        #joystick-area {
            position: absolute; bottom: 20px; left: 20px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,0,0.2);
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: yellow; border-radius: 50%; transform: translate(-50%, -50%);
        }

        /* Sağ Saldırı Butonu */
        #attack-btn {
            position: absolute; bottom: 40px; right: 40px;
            width: 100px; height: 100px; background: rgba(255,0,0,0.7);
            border: 3px solid white; border-radius: 50%; pointer-events: auto;
            display: none; align-items: center; justify-content: center; color: white; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 class="text-4xl font-black italic">BACKROOMS ONLINE</h1>
        <p id="matchmaking-text" class="mt-4 text-xl animate-pulse">SUNUCUYA BAĞLANILIYOR...</p>
        <button id="start-btn" class="hidden mt-6 bg-yellow-500 text-black px-10 py-3 rounded-full font-bold">OYUNA GİR</button>
    </div>

    <div id="ui-layer">
        <div id="joystick-area"><div id="joystick-knob"></div></div>
        <div id="attack-btn">VUR</div>
    </div>

    <script>
        // --- 1. SAHNE VE FİZİK AYARLARI ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a05);
        scene.fog = new THREE.Fog(0x1a1a05, 1, 20);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const walls = [];
        const wallMat = new THREE.MeshPhongMaterial({ color: 0x888844 });
        
        // Labirent Oluşturma ve Çarpışma Listesine Ekleme
        function createWall(x, z) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 4), wallMat);
            wall.position.set(x, 3, z);
            scene.add(wall);
            walls.push(new THREE.Box3().setFromObject(wall)); // Fizik kutusu
        }

        // Rastgele Labirent
        for(let i=-5; i<5; i++) {
            for(let j=-5; j<5; j++) {
                if(Math.random() > 0.6) createWall(i*8, j*8);
            }
        }

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshPhongMaterial({color: 0x444422}));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const light = new THREE.PointLight(0xffffff, 0.8, 15);
        camera.add(light);
        scene.add(camera);

        // --- 2. MULTIPLAYER (LOBİ) ---
        const socket = new WebSocket("wss://saskioyunu.onrender.com");
        let myId = null;
        let players = {};

        socket.onopen = () => {
            document.getElementById('matchmaking-text').innerText = "OYUNCU BEKLENİYOR (1/2)...";
        };

        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'sync') {
                const count = Object.keys(data.players).length;
                document.getElementById('matchmaking-text').innerText = `OYUNCU BULUNDU (${count}/10)`;
                if(count >= 2) document.getElementById('start-btn').classList.remove('hidden');
                syncPlayers(data.players);
            }
        };

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('lobby').style.display = 'none';
        };

        // --- 3. PUBG TARZI KONTROLLER ---
        let moveDir = { x: 0, z: 0 };
        const knob = document.getElementById('joystick-knob');
        
        // Sol Joystick Hareket
        document.getElementById('joystick-area').ontouchmove = (e) => {
            const touch = e.touches[0];
            const rect = e.currentTarget.getBoundingClientRect();
            let dx = touch.clientX - (rect.left + 75);
            let dy = touch.clientY - (rect.top + 75);
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
            const angle = Math.atan2(dy, dx);
            
            knob.style.left = `calc(50% + ${Math.cos(angle)*dist}px)`;
            knob.style.top = `calc(50% + ${Math.sin(angle)*dist}px)`;
            
            moveDir.x = Math.cos(angle) * (dist/50);
            moveDir.z = Math.sin(angle) * (dist/50);
        };

        document.getElementById('joystick-area').ontouchend = () => {
            knob.style.left = '50%'; knob.style.top = '50%';
            moveDir = { x: 0, z: 0 };
        };

        // Sağ Ekran Bakış
        let lastTouchX = 0;
        document.body.ontouchmove = (e) => {
            if(e.target.id === 'joystick-area') return;
            const tx = e.touches[0].clientX;
            if(lastX) camera.rotation.y -= (tx - lastX) * 0.008;
            lastX = tx;
        };
        document.body.ontouchend = () => lastX = 0;

        // --- 4. FİZİK VE DUVAR ÇARPIŞMASI ---
        function checkCollision(newPos) {
            const playerBox = new THREE.Box3().setFromCenterAndSize(
                newPos, new THREE.Vector3(1, 1, 1)
            );
            for(let wallBox of walls) {
                if(playerBox.intersectsBox(wallBox)) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(moveDir.x !== 0 || moveDir.z !== 0) {
                const nextPos = camera.position.clone();
                nextPos.addScaledVector(new THREE.Vector3(moveDir.x, 0, moveDir.z).applyQuaternion(camera.quaternion), 0.15);
                
                if(!checkCollision(nextPos)) {
                    camera.position.copy(nextPos);
                }
            }
            camera.position.y = 1.6;

            if(socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'update',
                    pos: { x: camera.position.x, z: camera.position.z, ry: camera.rotation.y }
                }));
            }
            renderer.render(scene, camera);
        }
        animate();

        // --- 5. TELEGRAM TAM EKRAN ---
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        if(tg.requestFullscreen) tg.requestFullscreen();
        tg.disableVerticalSwipes();
        tg.setHeaderColor('#1a1a00');
    </script>
</body>
</html>
