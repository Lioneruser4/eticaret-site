import amanobot
import amanobot.namedtuple
from amanobot.namedtuple import File, InlineKeyboardMarkup, InlineKeyboardButton
from amanobot.namedtuple import ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton, ForceReply
import random
import requests
from bs4 import BeautifulSoup
import time
import os
import json
from glob import glob
import pytz
from datetime import datetime
from config import TOKEN, ADMIN, OWNER, CHANNEL, GROUP, PROJECT_NAME

token = TOKEN
bot = amanobot.Bot(token)

queue = {
	"free":[],
	"occupied":{}
}
users = []
user3 = []

def saveConfig(data):
	return open('app.json', 'w').write(json.dumps(data))

if __name__ == '__main__':
	s = time.time()
	print(f'[#] Buatan\n[i] Created by @{OWNER}\n')
	print('[#] mengecek config...')
	if not os.path.isfile('app.json'):
		print('[#] memebuat config file...')
		open('app.json', 'w').write('{}')
		print('[#] Done')
	else:
		print('[#] Config found!')
	print('[i] Bot online ' + str(time.time() - s) + 's')
def exList(list, par):
	a = list
	a.remove(par)
	return a

def handle(update):
		
	global queue
	try:
		config = json.loads(open('app.json', 'r').read())
		if 'text' in update:
			text = update["text"]
		else:
			text = ""
		uid = update["chat"]["id"]
		
		if uid not in user3:
			users.append(uid)
		
		if not uid in config and text != "/Admin":
			config[str(uid)] = {"pics":True}
			saveConfig(config)

		if uid in queue["occupied"]:
			if 'text' in update:
				if text != "/exit" and text != "âŒ Ã‡Ä±x" and text != "SonrakÄ± â–¶ï¸" and text != "/search":
					bot.sendMessage(queue["occupied"][uid], "" + text)
			
			if 'photo' in update:
				photo = update['photo'][0]['file_id']
				bot.sendPhoto(queue["occupied"][uid], photo, caption=captionphoto)
                                
			if 'video' in update:
				video = update['video']['file_id']
				bot.sendVideo(queue["occupied"][uid], video, caption=captionvideo)
			
			if 'document' in update:
				document = update['document']['file_id']
				bot.sendDocument(queue["occupied"][uid], document, caption=captionducument)
				
			if 'audio' in update:
				audio = update['audio']['file_id']
				bot.sendAudio(queue["occupied"][uid], audio, caption=captionaudio)
				
			if 'video_note' in update:
				video_note = update['video_note']['file_id']
				bot.sendVideoNote(queue["occupied"][uid], video_note)
			        
			if 'voice' in update:
				voice = update['voice']['file_id']
				bot.sendVoice(queue["occupied"][uid], voice, caption=captionvoice)
                                
			if 'sticker' in update:
				sticker = update['sticker']['file_id']
				bot.sendSticker(queue["occupied"][uid], sticker)

			if 'contact' in update:
				nama = update["contact"][""]
				contact = update['contact']['']
				bot.sendContact(queue["occupied"][uid], contact, first_name=nama, last_name=None)
		                

		if text == "/start" or text == "/refresh":
			if not uid in queue["occupied"]:
				keyboard = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="Kanal", url=f"https://t.me/Bekartimeaz"),InlineKeyboardButton(text="SÃ¶hbÉ™t Qrupu", url=f"t.me/{GROUP}"),InlineKeyboardButton(text="Botlar", url=f"https://t.me/{CHANNEL}")]])
				bot.sendMessage(uid, f"**â¤ï¸ {PROJECT_NAME} XoÅŸ GÉ™ldiniz **â¤ï¸\n\n**ğŸ‡¦ğŸ‡¿ Ãœmid edirÉ™m ki, Ã–zÃ¼nÃ¼zÉ™ bir dost vÉ™ ya Sevgili tapacaqsÄ±nÄ±z ğŸ™‚\n âš ï¸ ÆtraflÄ± MÉ™lumat vÉ™ Problem HÉ™lli ÃœÃ§Ã¼n /help \nTez-Tez Partner Ã–tÃ¼rsÉ™niz Bot TÉ™rÉ™findÉ™n Spam OlunacaqsÄ±nÄ±z \nBotda Qrup ReklamÄ± QÉ™ti QadaÄŸandÄ±r! Botdan Ban vÉ™ Qrupunuz Linki YayÄ±lÄ±b DaÅŸÄ±dÄ±lacaq\n\nğŸ” ğŸ’¬ SÃ¶hbÉ™t EtmÉ™k Ã¼Ã§Ã¼n â¤ï¸  â¡ï¸  /search  â¬…ï¸  â¤ï¸ Toxunun vÉ™ ya YazÄ±n", parse_mode='MarkDown', disable_web_page_preview=True , reply_markup=keyboard)
		if 'message_id' in update:
			if not uid in queue["occupied"]:
				if text != "/start" and text != "Online Ä°stifadÉ™Ã§ilÉ™rğŸ‘¤" and text !="SonrakÄ± â–¶ï¸" and text != "/search" and text != "/search" and text != "/search" and text != "/search" and text != "MENU BOTâœ…" and text != "ğŸ”™ Main Menu" and text != "Axtar ğŸ”" and text != "Covid-19ã€½ï¸"  and text != "/help":
					news = ReplyKeyboardRemove()
					bot.sendMessage(uid, "**Bir sÃ¶hbÉ™tdÉ™ deyilsiniz\nZÉ™hmÉ™t olmasa Toxun** â¡ï¸  /search ", parse_mode="MarkDown",reply_markup=news, reply_to_message_id=update['message_id'])
		

		if text == "/test":
			if not uid in queue["occupied"]:
				lolt = ReplyKeyboardMarkup(keyboard=[
                    ['Plain text', KeyboardButton(text='Text only')],
					[dict(text='phone', request_contact=True), KeyboardButton(text='Location', request_location=True)]], resize_keyboard=True)
				bot.sendMessage(uid, "contoh", reply_markup=lolt)

		elif text == "Online Ä°stifadÉ™Ã§ilÉ™rğŸ‘¤":
			file = json.loads(open("app.json", "r").read())
			text = "Botda Online Ä°stifadÉ™Ã§ilÉ™rğŸ‘¤ : " + str(len(file)) + " OnlineğŸ‘¤"
			bot.sendMessage(uid, text)

		elif text == "/users":
			if str(uid) in ADMIN :
				file = open("is.txt", "r")
				text = "Ä°stifadÉ™Ã§i : " + str(len(file.readlines())) + "OnlineğŸ‘¤"
				bot.sendMessage(uid, text)
			else:
				bot.sendMessage(uid, "ï¸Bu É™mr yalnÄ±z admin ï¸ Ã¼Ã§Ã¼ndÃ¼r")
		elif text == '/melumat':
			if str(uid) in ADMIN :
				name = update["from"]["first_name"]
				_id = update["from"]["id"]
				username = update["from"]["username"]
				tipe = update["chat"]["type"]
				date1 = datetime.fromtimestamp(update["date"], tz=pytz.timezone("Azerbaijan/Baku")).strftime("%d/%m/%Y %H:%M:%S").split()
				text = "*Ad : " + str(name)+"*" +"\n"
				text += "*ID :* " +"`"+ str(_id) +"`"+"\n"
				text += f"*Kullanici Adi:* @{username}"+ "\n"
				text += "*Chat* : " +"_"+ str(tipe)+"_" +"\n"
				text += "*Tarix :* " + str(date1[0]) +"\n"
				text += "*Vaxt :* " + str(date1[1]) + " WIB" "\n"
				bot.sendMessage(uid, text, parse_mode='MarkDown', reply_to_message_id=update['message_id'])
			else:
				bahasa = update["from"]["language_code"]
				name = update["from"]["first_name"]
				_id = update["from"]["id"]
				bot.sendMessage(uid, f"Ad = {name}\nID = `{_id}`\Dil = {bahasa}", parse_mode="MarkDown")

		elif text == 'Axtar ğŸ”' or text == "/search":
			if not uid in queue["occupied"]:
				keyboard = ReplyKeyboardRemove()
				bot.sendMessage(uid, 'ğŸ” **SÃ¶hbÉ™t partneriniz axtarÄ±lÄ±r...**',parse_mode='MarkDown', reply_markup=keyboard)
				print("[SB] " + str(uid) + " SÃ¶hbÉ™tÉ™ qoÅŸulun")
				queue["free"].append(uid)

		elif text == 'âŒ Ã‡Ä±x' or text == '/exit' and uid in queue["occupied"]:
			print('[SB] ' + str(uid) + ' Ä°stifadÉ™Ã§ini tÉ™rk et ' + str(queue["occupied"][uid]))
			keyboard = ReplyKeyboardMarkup(keyboard=[['Axtar ğŸ”'],['Online Ä°stifadÉ™Ã§ilÉ™rğŸ‘¤','MENU BOTâœ…']], resize_keyboard=True, one_time_keyboard=True)
			bot.sendMessage(uid, "ğŸ’Œ SÃ¶hbÉ™ti Bitirdiniz..ğŸ§ @BTmusiqi \n\nYeni SÃ¶hbÉ™t ÃœÃ§Ã¼n â¤ï¸  â¡ï¸  /search  â¬…ï¸  â¤ï¸", parse_mode='MarkDown', reply_markup=keyboard)
			bot.sendMessage(queue["occupied"][uid], "ğŸ’” **Partneriniz Sizi TÉ™rk Etdi** ", parse_mode='MarkDown', reply_markup=keyboard)
			del queue["occupied"][queue["occupied"][uid]]
			del queue["occupied"][uid]

		elif text == 'MENU BOTâœ…': 
			keyboard = ReplyKeyboardMarkup(keyboard=[
				['Axtar ğŸ”','Covid-19ã€½ï¸'],['ğŸ”™ Main Menu']
			], resize_keyboard=True, one_time_keyboard=True)
			bot.sendMessage(uid, f"Kollektiv OlmaÄŸa SÃ¶hbÉ™t Qrupu AxtarÄ±rsÄ±nÄ±zsa GÉ™lin qrupa @{GROUP} vÉ™ Kanala @{CHANNEL} \n\nDigÉ™r Botlar @BTbots \nMusiqi KanalÄ± @BTmusiqiğŸ‘¨ğŸ»â€ğŸ’» \nSahibi : @Xaliqq", reply_markup=keyboard)

		elif text == 'Covid-19ã€½ï¸':
			web = requests.get('https://www.worldometers.info/coronavirus/country/Azerbaijan/')
			tampilan = BeautifulSoup(web.content, 'html.parser')
			dataweb = tampilan.find_all("div", {"class": "maincounter-number"})
			ouy = "*AzÉ™rbaycanda COVÄ°D-19 Virusu*\n\nViruslara mÉ™ruz qalma : {}| \nÃ–ldÃ¼ : {} | \nSaÄŸalan : {} ".format(dataweb[0].span.text,dataweb[1].span.text,dataweb[2].span.text)
			bot.sendMessage(uid, ouy, parse_mode='MarkDown')
			
		elif text == 'ğŸ”™ Main Menu':
			keyboard = ReplyKeyboardMarkup(keyboard=[['Axtar ğŸ”'],['Online Ä°stifadÉ™Ã§ilÉ™rğŸ‘¤','MENU BOTâœ…']], resize_keyboard=True, one_time_keyboard=True)
			bot.sendMessage(uid, "Kollektiv OlmaÄŸa SÃ¶hbÉ™t Qrupu AxtarÄ±rsÄ±nÄ±zsa GÉ™lin qrupa @BekarTimes vÉ™ Kanala @BTmusiqi \n\nğŸ‘¨ğŸ»â€ğŸ’» Sahibi : @Xaliqq", parse_mode='MarkDown', disable_web_page_preview=True, reply_markup=keyboard)
		elif text == "NÃ¶vbÉ™ti â–¶ï¸" or text == "/search" and uid in queue["occupied"]:
			print('[SB] ' + str(uid) + ' ilÉ™ sÃ¶hbÉ™ti bitirin ' + str(queue["occupied"][uid]))
			keyboard = ReplyKeyboardMarkup(keyboard=[['Axtar ğŸ”', 'ğŸ”™ Main Menu']], resize_keyboard=True, one_time_keyboard=True)
			bot.sendMessage(uid, " âœ‰ï¸ **Bu SÃ¶hbÉ™ti SonlandÄ±rdÄ±nÄ±z**...",parse_mode="MarkDown")
			bot.sendMessage(queue["occupied"][uid], " Partneriniz Sizi Ã–tÃ¼rdÃ¼... Toxun â–¶ï¸ /search ",parse_mode="MarkDown", reply_markup=keyboard)
			del queue["occupied"][queue["occupied"][uid]]
			del queue["occupied"][uid] 
			if not uid in queue["occupied"]:
				key = ReplyKeyboardRemove()
				bot.sendMessage(uid, 'Yeni partnyorunuzu axtarÄ±rsÄ±nÄ±z.. bir dÉ™qiqÉ™ gÃ¶zlÉ™yin',parse_mode="MarkDown" ,reply_markup=key)
				print("[SB] " + str(uid) + "ğŸˆ Partner TapÄ±ldÄ± , Salam YazÄ±n ğŸ™‚") 
				queue["free"].append(uid)
                 
		
		elif text == '/send':
			username = update["from"]["username"]
			bot.sendMessage(uid, f"*Salam MÉ™nim adÄ±m @{username}*\nÃ–zÉ™ldÉ™n sÃ¶hbÉ™t edÉ™k?",parse_mode="MarkDown" )

		if text == "/help":
			config[str(uid)]["pics"] = not config[str(uid)]["pics"] 
			if config[str(uid)]["pics"]:
				bot.sendMessage(uid, "âš ï¸ SÃ¶hbÉ™t EdÉ™rkÉ™n Etikadan KÉ™nara Ã‡Ä±xmayÄ±n  ,\n TÉ™hqir EdilÉ™rsÉ™niz MesajÄ± ScreenShot Edib @BekarTime_bot 'a GÃ¶ndÉ™rin ,\n Sizin Ä°D'nizÉ™ BaxÄ±b Son Partner OlduÄŸunuz ÅÉ™xsin Ä°D'sin GÃ¶rÉ™ Bilirik \n Kobud RÉ™fdar EdÉ™n ÅÉ™xs Bot'dan Ban Olunacaq! \n\nBot SizdÉ™ Ä°ÅŸlÉ™mirsÉ™ Partner AxtarmÄ±rsa BunlarÄ± TÉ™k YazÄ±n \n\n /exit  /stop  /refresh  \n\nğŸ¯BT SÃ¶hbÉ™t vÉ™ Oyun Qrupu â¡ï¸ @BekarTimes \n âœ… MÉ™lumat KanalÄ± â¡ï¸ @BekarTimeaz \n ğŸ§ Musiqi KanalÄ± â¡ï¸ @BTmusiqi")
			else:
				bot.sendMessage(uid, "ğŸ” Anonimlik Tam Qorunur Report olunmasanÄ±z HeÃ§ Bir MÉ™lumatÄ±nÄ±z ÆldÉ™ EdilÉ™ BilmÉ™zâš ï¸ GÃ¶ndÉ™rdiyiniz Video , Gif , ÅÉ™kil , SÉ™s PartnerinizdÉ™ GÃ¶rÃ¼nmÃ¼r YalnÄ±z Stiker \n âš ï¸ SÃ¶hbÉ™t EdÉ™rkÉ™n Etikadan KÉ™nara Ã‡Ä±xmayÄ±n âš ï¸ ,\n TÉ™hqir EdilÉ™rsÉ™niz MesajÄ± ScreenShot Edib @BekarTime_bot 'a GÃ¶ndÉ™rin ,\n ğŸ‘¤Sizin Ä°D'nizÉ™ BaxÄ±b Son Partner OlduÄŸunuz ÅÉ™xsin Ä°D'sin GÃ¶rÉ™ Bilirik \n âŒKobud RÉ™fdar EdÉ™n ÅÉ™xs Bot'dan Ban Olunacaq! \n âš ï¸ Botda UserlÉ™rÉ™ Reklam Atmaq Olmaz Botda Qrup ReklamÄ± QÉ™ti QadaÄŸandÄ±r! Botdan Ban vÉ™ Qrupunuz Linki YayÄ±lÄ±b DaÅŸÄ±dÄ±lacaq! âš ï¸ \n\n ğŸ¯BT SÃ¶hbÉ™t Qrupu â¡ï¸ @BekarTimes \n âœ… MÉ™lumat KanalÄ± â¡ï¸ @BekarTimeaz \n ğŸ§ Musiqi KanalÄ± â¡ï¸ @BTmusiqi")
			saveConfig(config)

		if len(queue["free"]) > 1 and not uid in queue["occupied"]:
			partner = random.choice(exList(queue["free"], uid))
			if partner != uid:
				keyboard = ReplyKeyboardMarkup(keyboard=[
					['NÃ¶vbÉ™ti â–¶ï¸', 'âŒ Ã‡Ä±x'],
				],resize_keyboard=True, one_time_keyboard=True)
				print('[SB] ' + str(uid) + ' ilÉ™ uyÄŸunlaÅŸÄ±n ' + str(partner))
				queue["free"].remove(partner)
				queue["occupied"][uid] = partner
				queue["occupied"][partner] = uid
				bot.sendMessage(uid, 'ğŸˆ**Partneriniz tapÄ±ldÄ±, Salam YazÄ±n** ğŸ™‚ ',parse_mode='MarkDown', reply_markup=keyboard)
				bot.sendMessage(partner, 'ğŸˆ**Partneriniz tapÄ±ldÄ±, Salam YazÄ±n** ğŸ™‚',parse_mode='MarkDown', reply_markup=keyboard)
	except 	Exception as e:
		print('[!] Error: ' + str(e))

if __name__ == '__main__':
	bot.message_loop(handle)

	while 1:
		time.sleep(3)
